---
title: "STE_query_plots"
author: "Sam Cheng, David Gill"
date: "May 14, 2018"
output: html_document
---
##Setup
load packages, set file directories
```{r}
library(tidyr)
library(gplots)
library(RColorBrewer)
library(viridis)
library(extrafont)
library(ggthemes)
library(ggplot2)
library(d3Network)
library(treemap)
library(maptools)
library(rio)
library(cowplot)
library(circlize)
library(dplyr)

# setwd("~/Documents/github/marine_ste/")
# map_data_final <- readRDS("data/map_data_final_4_24.rds")
# load("data/STE_Evidence_Map_2_10_2018.RData")
# Directories
dropbox <- "C:/Users/dgill6/Dropbox/SynergiesTradeoffs.Review/Data extraction/"
datadir <- "C:/Users/dgill6/Dropbox/data/analysis/STEreview/"
# Projections
wgs84 <- CRS("+proj=longlat +ellps=WGS84")

```

### Read in and prep data
```{r eval=T}
ext.table <- import(paste0(dropbox,'STE extracted results to date.xlsx'), sheet = 1) 
# paste0('Are article and outcome exclusion values are identical? ',identical(ext.table$`05 Exclude`,ext.table$`40 Exclude`))
# if (!identical(ext.table$`05 Exclude`,ext.table$`40 Exclude`)){
#   View(ext.table[ext.table$`05 Exclude`!=ext.table$`40 Exclude`,])
#   ext.table <- ext.table[ext.table$`05 Exclude`==ext.table$`40 Exclude`,]
# }

names(ext.table) <- gsub(" ","_",names(ext.table))
ext.data <- ext.table %>% 
  rename(aid='Data_extraction_questionnaire.01_Article_ID',
         Assessor="02_Name_of_Assessor",
         Assess_date="04_Date_of_assessment",
         exclude='05_Exclude',
         Pub_type='11_Publication_type',
         Authors="12_Author",
         Pub_year='13_Year_of_publication',
         Title="14_Title",
         Journal='15_Journal', 
         source='110_Source', 
         auth_aff='17_Affiliation_type_of_first_author',
         Funding="18_Funding_source",
         DOI="19_DOI",
         Source="110_Source",
         Bib_notes="111_notes_on_bibliography",
         Int_type='22_Type_of_intervention',
         int_scale='24_Geographic_scale_of_intervention',           
         int_time='25_Timeframe_of_intervention',           
         int_auth='27_Managing_authority',           
         Int_location='28_Intervention_location',           
         Int_area='29_Intevention_area',
         Stated_int="21_Stated_intervention",
         Desired_out="23_Desired_outcome_of_intervention",
         Int_dur="25_Timeframe_of_intervention",
         Int_funding="26_Funding_source",
         Int_notes="210_notes_on_intervention",
         Study_goal="31_Stated_goal_of_the_study",
         Study_type='32_Study_type',
         Design.control_comp='33_Study_includes_a_comparison/control_group',
         Comp_type='34_Type_of_comparison_(control_group)',
         Data_source='35_Data_source',
         Study_location="36_Location_of_study",
         Study_country='37_Country_of_study',
         stdy_scl='38_Study_scale',           
         Biome.='39_Biome', 
         eval_aff='310_Affliation_of_evaluator',           
         Unit_analysis='311_Social_unit_of_analysis', 
         Sample_Size='312_Sample_size_(maximum)', 
         Study_duration='313_Duration_of_study',
         Study_notes="314_notes_on_study_type",
         Distributive_equity='51_Distributive_equity', 
         Recognitional_equity='52_Recognitional_equity', 
         Contextual_equity='53_Contextual_equity', 
         Procedural_equity='54_Procedural_equity',
         Equity_notes="55_Equity_notes",
         Causal_pathway='61_Causal_pathway/theory_of_change', 
         Explicit_mechanism='62_Explicit_mechanism', 
         Pathway_notes="63_Pathway_notes",
         oid='OutcomeID',
         Stated_outcomes='41_Stated_outcome_measured',
         Out_type='42_Outcome_domain',
         Out_subtype='43_Outcome_attribute',
         Indicators='44_Outcome_indicator',
         Out_definition='45_Perceptions_vs_observed_outcome',
         Outcome.data_type='46_Outcome_data-type',
         Resource_type='47_Resource_use_type',
         Outcome.direction='48_Overall_outcome_direction',
         Pluralism='49_Pluralism_(who_defines_STEs?)',
         Out_subgroup='410_Outcome_sub-group',
         STE_domain='411_STE:_social_domain/HWB_outcomes',
         STE_econ='412_STE:_(economic_status)',
         STE_social='413_STE:__(social_status)',
         STE_sex='414_STE:__(sex)',
         STE_ethnic='415_STE:__(ethnic_group/race)',
         STE_age='416_STE:__(age)',           
         STE_occupation='417_STE:__(occupation)',
         STE_social_org='418_STE:_level_of_social_organization',
         STE_spatial='419_STE:_spatial_units',
         STE_temporal_unit='420_STE:_temporal_units',
         STE_temporal_scale='421_STE:_temporal_scales', 
         Outcome_notes="422_Outcome_notes" 
  )

# remove open-ended or unneeded variables, spread multi-choice variables
unwanted.var <- grep('(\\d)',names(ext.data),value = T) # variables that still contain a number in the name
data <- ext.data %>% 
  select(-one_of(unwanted.var)) %>%
  mutate(Comp_type=gsub("Pre-treatment/post-treatment","Pre/post treatment",Comp_type),
         Int_type=gsub("CBNRM, MPA","CBNRM_MPA",Int_type),
         Affil_type.Academic=ifelse(grepl("Academic",auth_aff),1,0),
         Affil_type.Public_sector=ifelse(grepl("Public",auth_aff),1,0),
         Affil_type.Research_Institute=ifelse(grepl("Research",auth_aff),1,0),
         Affil_type.Consultant=ifelse(grepl("Consultant",auth_aff),1,0),
         Affil_type.Non_profit=ifelse(grepl("profit",auth_aff),1,0),
         Affil_type.Private_sector=ifelse(grepl("Private",auth_aff),1,0),
         Affil_type.International_Organization=ifelse(grepl("International",auth_aff),1,0),
         Int_type.MPA=ifelse(grepl("MPA",Int_type),1,0),
         Int_type.PES=ifelse(grepl("PES",Int_type),1,0),
         Int_type.CBNRM=ifelse(grepl("CBNRM",Int_type),1,0),
         Int_type.Certification=ifelse(grepl("Certification",Int_type),1,0),
         Int_geo.local=ifelse(grepl("Local",int_scale),1,0),
         Int_geo.region=ifelse(grepl("Region",int_scale),1,0),
         Int_geo.national=ifelse(grepl("National",int_scale),1,0),
         Int_geo.subnational=ifelse(grepl("Sub-national",int_scale),1,0),
         Int_geo.international=ifelse(grepl("International",int_scale),1,0),
         Mang_auth.Government=ifelse(grepl("Government",int_auth,ignore.case = T),1,0),
         Mang_auth.Shared_governance=ifelse(grepl("shared",int_auth,ignore.case = T),1,0),
         Mang_auth.Private_governance=ifelse(grepl("private",int_auth,ignore.case = T),1,0),
         Mang_auth.Indigenous_community_governance=ifelse(grepl("Indigenous",int_auth,ignore.case = T),1,0),
         Mang_auth.multiple=ifelse(grepl("multiple",int_auth),1,0),  
         Mang_auth.mixed=ifelse(grepl("mixed",int_auth,ignore.case = T),1,0),
         Comp_type.dist=ifelse(grepl("Distance",Comp_type),1,0),
         Comp_type.treat=ifelse(grepl("Treated/Untreated",Comp_type),1,0),
         Comp_type.prepost=ifelse(grepl("Pre/post",Comp_type),1,0),
         Comp_type.BACI=ifelse(grepl("BACI",Comp_type),1,0),
         Comp_type.BACI=ifelse(grepl("BACI",Comp_type),1,0)         
) %>% 
        filter(exclude==FALSE)
```
### Basic plot functions (for next chunk of plots)
```{r eval=T}
# article level stats
ste_gp <- function (x,y) {
  data %>% 
    group_by_(x,y) %>% 
    summarise(num=n()) %>%
    arrange(-num) %>%
    ggplot(aes_q(y))+
    geom_bar(stat='count') +
    coord_flip() +
    theme_bw() +
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())
}
# outcome level stats
ste_gp_o <- function (z) {
 data %>% 
  filter(!is.na(z)) %>%
  group_by_(z) %>% 
  summarise(num=n()) %>%
  arrange(-num) }
ste_hist <- function () {
  list(
    geom_histogram(stat='identity'),
    coord_flip(),
    theme_bw(),
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())
  )
}

```

### Intervention and study plots
```{r eval=T}
#Percent excluded
pExclude <- ext.table %>% 
    rename(aid='Data_extraction_questionnaire.01_Article_ID',
         exclude='05_Exclude') %>% 
    group_by(aid,exclude) %>% 
    summarise(num=n()) %>% 
  ggplot(aes(exclude)) +
    geom_histogram(stat='count') +
    coord_flip() +
    xlab("Excluded articles") +
    theme_bw() +
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())

# Publication year
table(data$Pub_year)
minyr <- min(data$Pub_year)-1;maxyr <- max(data$Pub_year)+1
pPubyr<- data %>% 
    group_by(aid,Pub_year) %>% 
    summarise() %>% 
    ggplot(aes(Pub_year))+
    geom_histogram(stat='count') +
    scale_x_continuous("Publication year", breaks=seq(minyr,maxyr,5)) +
    theme_bw() +
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())

# Publication type
pPubtype<-ste_gp(~aid,~Pub_type) +
  xlab("Publication type")

# Author affliation
table(data$auth_aff)
pAuth_aff<-ste_gp(~aid,~auth_aff) +
  xlab("Author affliation")

# Intervention type
table(data$Int_type)/nrow(data)
pInt_typ<-ste_gp(~aid,~Int_type) +
  xlab("Intervention type")

# Intervention scale
table(data$int_scale)/nrow(data)
pInt_scale<-ste_gp(~aid,~int_scale) +
  xlab("Intervention scale")

# Type of study
table(data$Study_type)/nrow(data)
pStudy_typ<-ste_gp(~aid,~Study_type) +
  xlab("Study type")

# Study data source
table(data$Data_source)/nrow(data)
pStdy_source<-ste_gp(~aid,~Data_source) +
  xlab("Study data source")

# Study scale
table(data$stdy_scl)/nrow(data)
pStdy_scl<-ste_gp(~aid,~stdy_scl) +
  xlab("Study scale")

# Control group
table(data$Design.control_comp)/nrow(data)
pCtrl_gp<-ste_gp(~aid,~Design.control_comp) +
  xlab("Control group")

# Control group type
table(data$Comp_type)/nrow(filter(data,Design.control_comp==T))
pCtrl_typ<-ste_gp(~aid,~Comp_type) +
  xlab("Control group type")

# Biome
table(data$Biome.)
pBiome<-ste_gp(~aid,~Biome.) +
  xlab("Biome")

# Country
table(data$Study_country)
pCountry<-ste_gp(~aid,~Study_country) +
  xlab("Study country")


# About study
plot_grid(pExclude,pPubyr,pPubtype,pAuth_aff,
          labels=letters[1:4], ncol = 2, nrow = 2, hjust=-1)

# About intervention
plot_grid(pInt_typ,pInt_scale,pBiome,pCountry
          ,labels=letters[1:4], ncol = 2, nrow = 2, hjust=-1)

# About study
plot_grid(pStudy_typ,pStdy_source,pStdy_scl,pCtrl_gp,pCtrl_typ,
          labels=letters[1:5], ncol = 3, nrow = 2, hjust=-1)
```

### Outcome plots
```{r eval=T}
# Outcome domain
pOut_domain <- ste_gp_o('Out_type') %>% 
ggplot(aes(x=reorder(Out_type,num),y=num))+
  ste_hist() +
  xlab('Outcome domain')

# Data type
table(data$Outcome.data_type)/sum(!is.na(data$Outcome.data_type))
pDatatype <-  ste_gp_o('Outcome.data_type') %>% 
  ggplot(aes(x=reorder(Outcome.data_type,num),y=num))+
  ste_hist() +
  xlab("Outcome data type")
 
# Perceived vs observed
table(data$Out_definition)
data$outcome_obs1 <- ifelse(data$Out_definition%in%c('Researcher','Respondent'),
                                data$Out_definition,"Both")
table(data$outcome_obs1)/sum(!is.na(data$outcome_obs1))
pDataobs <- ste_gp_o('outcome_obs1') %>% 
  ggplot(aes(x=reorder(outcome_obs1,num),y=num))+
  ste_hist() +
  xlab("Data 'observer'")

# Dimensions
ste.data <- data %>% 
  select(STE_domain:STE_temporal_scale)

ste.data1 <-as.data.frame(apply(ste.data, 2, function(x) sum(!is.na(x))))
names(ste.data1)[1] <- "total"
ste.data1$var <- gsub('STE_','',row.names(ste.data1))

pSTE <- ggplot(ste.data1,aes(x=reorder(var,total),y=total)) +
    ste_hist() +
    xlab("STE dimension") 

plot_grid(pDatatype,pDataobs,pOut_domain, pSTE,labels=letters[1:4], 
          ncol = 2, nrow = 2, hjust=-1)

```

### Heat maps
```{r eval=T}
io_counts <- data %>% 
        filter(exclude==FALSE) %>% 
        group_by(Int_type,Out_type) %>% 
        count() %>% 
        spread(key=Int_type, value=n) %>% 
        mutate(PES=0) %>%
        gather("Int_type","n",CBNRM:PES) %>% 
        mutate(n=ifelse(is.na(n),0,as.integer(n)))

# out_type <- c("Economic well-being","Health","Political empowerment","Social capital","Education","Culture")
# int_type <- c("MPA","PES","CBNRM","CBNRM_MPA","Certification")
# 
# io_counts = matrix(nrow=6, ncol=5)
# rownames(io_counts) <- out_type
# colnames(io_counts) <-int_type
# 
# for (i in int_type){
#   for (j in out_type){
#     subset <- filter(data, Out_type == j, Int_type == i)
#     io_counts[j,i] <- n_distinct(subset$aid)
#   }
# }
# 
# rownames(io_counts) <- out_type
# colnames(io_counts) <- int_type
# io_counts <- as.data.frame(io_counts)
# io_counts$Out_type <- rownames(io_counts)
# io_counts <- gather(io_counts,"Int_type","n",1:5)

heat.map.all <- ggplot(io_counts, aes(x=Out_type,y=Int_type,fill=n)) +
  geom_tile(color="gray90",size=0.1) +
  geom_text(aes(label=n),show.legend = F) +
  scale_fill_gradient(low="#f7fbff",high="#084594",name="# Cases",na.value="gray90") +
  coord_equal() +
  theme_tufte(base_family="Helvetica") +
  theme(axis.ticks=element_line(size=0.4)) +
  theme(axis.text=element_text(size=12)) +
  theme(legend.title=element_text(size=10)) +
  theme(legend.text=element_text(size=10)) +
  theme(legend.title.align=1) +
  theme(legend.position="bottom") +
  theme(legend.key.size=unit(1, "cm")) +
  theme(legend.key.width=unit(1, "cm")) +
  theme(axis.text.x = element_text(angle=45,hjust=1,size=12))

heat.map.all

##BY STE TYPE AND OUTCOME DOMAIN - HEATMAP

# ste_outcomes <- select(data,aid,oid,Int_type,Out_type,STE_domain,STE_econ,STE_social,STE_sex,STE_ethnic,STE_age,STE_social_org,STE_social_org,STE_spatial,STE_temporal_unit,STE_temporal_scale) %>% distinct() 
# 
# ste_outcomes2 <- ste_outcomes %>% gather("ste_type","ste_interaction",5:15) %>% arrange(Int_type) %>% filter(ste_interaction != "NA") %>% distinct() %>% filter(!is.na(Out_type)) %>% filter(!is.na(Int_type))
# 
# n_distinct(ste_outcomes2$aid)
# n_distinct(ste_outcomes2$oid)
# 
# ste_outcomes3 <- ste_outcomes2 %>% select(-aid)

ste_types <- c("STE_domain","STE_econ","STE_social","STE_sex","STE_ethnic","STE_age","STE_social_org","STE_social_org","STE_spatial","STE_temporal_unit","STE_temporal_scale")

# matrix <- count(ste_outcomes3,Out_type,Int_type,ste_type)
# matrix2 <- matrix %>% ungroup() %>% mutate(Int_type=factor(Int_type, levels=c("MPA","CBNRM","CBNRM_MPA","Certification")))
# matrix2$n <- as.numeric(matrix2$n)

ste_outcomes <- data %>% 
  select(aid,oid,Int_type,Out_type,STE_domain:STE_temporal_scale) %>% 
  distinct() %>% 
  gather("ste_type","ste_interaction",STE_domain:STE_temporal_scale) %>% 
  arrange(Int_type) %>% 
  filter(ste_interaction != "NA") %>% 
  distinct() %>% 
  filter(!is.na(Out_type)) %>% 
  filter(!is.na(Int_type))

n_distinct(ste_outcomes$aid)
n_distinct(ste_outcomes$oid)

matrix2 <- ste_outcomes %>% 
  select(-aid) %>% 
  count(Out_type,Int_type,ste_type) %>% 
  ungroup() %>% 
  mutate(Int_type=factor(Int_type, levels=c("MPA","CBNRM","CBNRM_MPA","Certification")),
         n=as.numeric(n)) 

all_poss <- expand.grid(Out_type=unique(matrix2$Out_type),ste_type=unique(matrix2$ste_type),Int_type=unique(matrix2$Int_type))
all_merge <- merge(matrix2,all_poss,by=c("Out_type","ste_type","Int_type"),all=TRUE) %>% arrange(Int_type)

heat.map.int <- ggplot(all_merge, aes(x=ste_type,y=Out_type,fill=n)) + 
  geom_tile(color="gray90",size=0.1) +
  geom_text(aes(label=n, color="white")) +
  scale_fill_gradient(low="#f7fbff",high="#084594",name="# Cases",na.value="gray90") +
  coord_equal() +
  facet_wrap(~Int_type, ncol=3) +
  labs(x="STE Type",y=NULL,
       title=paste0("STEs observed in domains of human well-being amongst marine conservation interventions (",
                    n_distinct(ste_outcomes$oid), " cases in ",n_distinct(ste_outcomes$aid)," articles)")) +
  theme_tufte(base_family="Helvetica") +
  theme(plot.title=element_text(hjust=0)) +
  theme(axis.ticks=element_line(size=0.4)) +
  theme(axis.text=element_text(size=7)) +
  theme(panel.border=element_rect(fill=NA,size=0.1)) +
  theme(strip.text=element_text(hjust=0)) +
  theme(panel.spacing.x=unit(0.5, "cm")) +
  theme(panel.spacing.y=unit(0.5, "cm")) +
  theme(legend.title=element_text(size=6)) +
  theme(legend.text=element_text(size=6)) +
  theme(legend.title.align=1) +
  theme(legend.position="bottom") +
  theme(legend.key.size=unit(0.2, "cm")) +
  theme(legend.key.width=unit(1, "cm")) +
  theme(axis.text.x = element_text(angle=45,hjust=1,size=7))

heat.map.int
```
### Plot world map
I can't seem to get the fortify function to work on my system with Sam's map. Also prefer to use lines 330-346 for wrangling the data, but can't do much without the map. If it works for others, then this is fine
```{r eval=T}
#load in full country list
country <- read.csv(paste0(datadir,"allcountries.csv"), head=TRUE, sep=",")
names(country) <- c("Study_country", "Region", "Code", "Subregion")
regions <- country
regions <- arrange(regions,Region)

#Fix aids with multiple countries
ctry <- data %>% 
  group_by(aid,Study_country) %>% 
  summarise() %>% 
  separate(Study_country,c('ctry1','ctry2'),sep=",",remove = F) %>%
  filter(ctry2 != " United Republic Of") %>%
  filter(ctry2 != " Province Of China") %>%
  gather(key=ctry.col,value=ctry,ctry1:ctry2) %>%
  select(aid,ctry)

colnames(ctry) <- c("aid","Study_country")

for_plotting <- select(data,aid,Study_country)
ctry <- bind_rows(ctry,for_plotting)

##Count number of studies for all countries and arrange by region
country_count <- matrix(nrow=nrow(regions), ncol=2)
rownames(country_count) <- regions$Study_country
colnames(country_count) <- c("Study_country", "counts")
#Calculate in for loop and write to blank matrix
for (c in regions$Study_country){
  subset <- filter(ctry, Study_country == c)
  country_count[c,1] <- c
  country_count[c,2] <- as.numeric(n_distinct(subset$aid))
}
#Remove rownames and reformat data types
rownames(country_count) = NULL
country_count <- as.data.frame(country_count, stringsAsFactors=FALSE)
countries_only <- inner_join(country_count,regions,by="Study_country")
countries_only <- filter(countries_only, Code != "")

countries_only$counts <- as.numeric(countries_only$counts)
countries_only <- as.data.frame(countries_only)
countries_zero <- filter(countries_only, counts == 0)

map <- readShapeSpatial(paste0(datadir,"TM_WORLD_BORDERS-0.3/TM_WORLD_BORDERS-0.3.shp"))
plot(map)
map <- fortify(map, region="ISO3")

pdf(file=paste0(datadir,"STE_Country_Map_dark_5_11.pdf"), width=16, height=8.5)
ggplot() +
  geom_map(data=countries_only, aes(map_id=Code, fill=counts),map=map) +
  geom_map(data=countries_zero, aes(map_id=Code),fill="#f0f0f0",map=map) +
  expand_limits(x=map$long,y=map$lat) +
  theme(panel.background = element_rect(fill = "darkgray", colour = "darkgray"), panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  scale_fill_gradient2(low="#f7fbff",mid="#6baed6",high="#08306b",midpoint=(max(countries_only$counts)/2),limits=c(0,max(countries_only$counts)))
dev.off()
# map <- st_read(paste0(datadir,"TM_WORLD_BORDERS-0.3/TM_WORLD_BORDERS-0.3.shp")) 
# plot(map)
# head(map)
# map <- fortify(map, region="ISO3")
# 
# 
# # Summarise data by country (ignore warnings)
# ctry <- data %>% 
#   filter(exclude=='FALSE') %>% 
#   mutate(Study_country=gsub(",",";",Study_country),
#          Study_country=gsub("Tanzania; United Republic Of","Tanzania, United Republic Of",Study_country),
#          Study_country=gsub("Taiwan; Province Of China","Taiwan, Province Of China",Study_country)) %>% 
#   group_by(aid,Study_country) %>% 
#   summarise() %>% 
#   separate(Study_country,c('ctry1','ctry2'),sep="; ",remove = F) %>% 
#   gather(key=ctry.col,value=ctry,ctry1:ctry2) %>% 
#   filter(!is.na(ctry)) %>% 
#   select(-Study_country,-ctry.col) %>% 
#   left_join(country,by=c("ctry"="Country")) %>% 
#   group_by(ctry,code) %>% 
#   count() %>% 
#   rename(ISO3=code) %>% 
#   ungroup() 
#   
# nrow(ctry)
# 
# pdf(file=paste0(datadir,"STE_Country_Map_dark_5_11.pdf"), width=16, height=8.5)
# ggplot() + 
#   geom_map(data=country, aes(map_id=ISO3),fill="#f0f0f0",alpha=0.25,map=map) + 
#   geom_map(data=ctry, aes(map_id=ISO3, fill=n),map=map) + 
#   expand_limits(x=map$long,y=map$lat) + 
#   theme(panel.background = element_rect(fill = "darkgray", colour = "darkgray"), panel.grid.major = element_blank(), panel.grid.minor = element_blank()) + 
#   scale_fill_gradient2(low="#f7fbff",mid="#6baed6",high="#08306b",midpoint=(max(ctry$n)/2),limits=c(1,max(ctry$n)))
# dev.off()

```
### Chord diagram
No tradeoffs for CBNRM
```{r eval=T}
## Trying with chord diagram instead

###########################
##FOR MPAS
###########################
mpa_outcomes <- filter(data,Int_type == "MPA") %>% distinct()
syn <- filter(mpa_outcomes,STE_domain == "Synergy") %>% arrange(Out_type,aid)
tradeoff <- filter(mpa_outcomes,STE_domain == "Tradeoff") %>% arrange(Out_type,aid)
both <- filter(mpa_outcomes,STE_domain == "Both Syn/Trd") %>% arrange(Out_type,aid)

#Create input for tradeoffs
aid <- as.list(unique(tradeoff$aid))

# links <- matrix(nrow=1,ncol=3)
# colnames(links) <- c("source","target","aid")
# links <- as.data.frame(links)
links <- data.frame(source=NA,target=NA,aid=NA)

for(i in aid){
  sub <- filter(tradeoff, aid == i)
  if(nrow(sub) > 1){
    sub2 <- as.data.frame(t(combn(sub$Out_type, 2)))
    colnames(sub2) <- c("source","target")
    sub2$aid <- c(i)
    links <- bind_rows(links,sub2)
  } else 
    links
}

links <- slice(links,-1)

##Count links 
mpa.counts.trdoff <- count(links,source,target)
colnames(mpa.counts.trdoff) <- c("source","target","value") 
mpa.counts.trdoff <- as.data.frame(mpa.counts.trdoff)

##For synergies

aid2 <- as.list(unique(syn$aid))

links2 <- matrix(nrow=1,ncol=3)
colnames(links2) <- c("source","target","aid")
links2 <- as.data.frame(links2)

for(i in aid2){
  sub <- filter(syn, aid == i)
  if(nrow(sub) > 1){
    sub2 <- as.data.frame(t(combn(sub$Out_type, 2)))
    colnames(sub2) <- c("source","target")
    sub2$aid <- c(i)
    links2 <- bind_rows(links2,sub2)
  } else 
    links2
}

links2 <- slice(links2,-1)

##Count links 
mpa.counts.syn <- count(links2,source,target)
colnames(mpa.counts.syn) <- c("source","target","value") 
mpa.counts.syn <- as.data.frame(mpa.counts.syn)

#Create input for both
aid3 <- as.list(unique(both$aid))

links3 <- matrix(nrow=1,ncol=3)
colnames(links3) <- c("source","target","aid")
links3 <- as.data.frame(links3)

for(i in aid3){
  sub <- filter(both, aid == i)
  if(nrow(sub) > 1){
    sub2 <- as.data.frame(t(combn(sub$Out_type, 2)))
    colnames(sub2) <- c("source","target")
    sub2$aid <- c(i)
    links3 <- bind_rows(links3,sub2)
  } else 
    links3
}

links3 <- slice(links3,-1)

##Count links 
mpa.counts.both <- count(links3,source,target)
colnames(mpa.counts.both) <- c("source","target","value") 
mpa.counts.both <- as.data.frame(mpa.counts.both)

grid.col <- c("Economic well-being"="#66c2a5","Social capital"="#fc8d62", "Culture"="#8da0cb", "Political empowerment"="#e78ac3","Education"="#a6d854","Health"="#ffd92f")
#pdf(file=paste0(datadir,"STE by Domain - MPA_4_24.pdf"),width=11,height=8.5)
par(mfrow=c(1,2),oma=c(0,0,2,0))
chordDiagram(as.data.frame(counts), transparency = 0.3, grid.col=grid.col) 
title("Tradeoffs (n=16 articles, x=46 cases)",line=-3.5)
chordDiagram(as.data.frame(mpa.counts.both), transparency = 0.3, grid.col=grid.col)
title("Both (n=16 articles, x=46 cases)",line=-3.5)
chordDiagram(as.data.frame(mpa.counts.syn), transparency = 0.3, grid.col=grid.col)
title("Synergies (n=26 articles, x=70 cases)",line=-3.5)
mtext("STE by outcome domain type in MPAs",outer=TRUE,cex=1.5)
#dev.off()

###########################
##for CBNRM
###########################
cbnrm_outcomes <- filter(data,Int_type %in% c("CBRNM_MPA","CBNRM")) %>% distinct()
syn <- filter(cbnrm_outcomes,STE_domain == "Synergy") %>% arrange(Out_type,aid)
tradeoff <- filter(cbnrm_outcomes,STE_domain == "Tradeoff") %>% arrange(Out_type,aid)
both <- filter(cbnrm_outcomes,STE_domain == "Both Syn/Trd")

#Create input for tradeoffs
aid <- as.list(unique(tradeoff$aid))

links <- matrix(nrow=1,ncol=3)
colnames(links) <- c("source","target","aid")
links <- as.data.frame(links)

for(i in aid){
  sub <- filter(tradeoff, aid == i)
  if(nrow(sub) > 1){
    sub2 <- as.data.frame(t(combn(sub$Out_type, 2)))
    colnames(sub2) <- c("source","target")
    sub2$aid <- c(i)
    links <- bind_rows(links,sub2)
  } else 
    links
}

links <- slice(links,-1)

##Count links 
counts <- count(links,source,target)
colnames(counts) <- c("source","target","value") 
counts <- as.data.frame(counts)

##For synergies

aid2 <- as.list(unique(syn$aid))

links2 <- matrix(nrow=1,ncol=3)
colnames(links2) <- c("source","target","aid")
links2 <- as.data.frame(links2)

for(i in aid2){
  sub <- filter(syn, aid == i)
  if(nrow(sub) > 1){
    sub2 <- as.data.frame(t(combn(sub$Out_type, 2)))
    colnames(sub2) <- c("source","target")
    sub2$aid <- c(i)
    links2 <- bind_rows(links2,sub2)
  } else 
    links2
}

links2 <- slice(links2,-1)

##Count links 
cbnrm.counts.syn <- count(links2,source,target)
colnames(cbnrm.counts.syn) <- c("source","target","value") 
cbnrm.counts.syn <- as.data.frame(cbnrm.counts.syn)

##For both

aid3 <- as.list(unique(syn$aid))

links3 <- matrix(nrow=1,ncol=3)
colnames(links3) <- c("source","target","aid")
links3 <- as.data.frame(links3)

for(i in aid3){
  sub <- filter(syn, aid == i)
  if(nrow(sub) > 1){
    sub3 <- as.data.frame(t(combn(sub$Out_type, 2)))
    colnames(sub3) <- c("source","target")
    sub3$aid <- c(i)
    links3 <- bind_rows(links3,sub3)
  } else 
    links3
}

links3 <- slice(links3,-1)

##Count links 
cbnrm.counts.both <- count(links3,source,target)
colnames(cbnrm.counts.both) <- c("source","target","value") 
cbnrm.counts.both <- as.data.frame(cbnrm.counts.both)

grid.col <- c("Economic well-being"="#66c2a5","Social capital"="#fc8d62", "Culture"="#8da0cb", "Political empowerment"="#e78ac3","Education"="#a6d854","Health"="#ffd92f")
#pdf(file=paste0(datadir,"STE by Domain - CBNRM_4_24.pdf"),width=11,height=8.5)
par(mfrow=c(1,2),oma=c(0,0,2,0))
# chordDiagram(as.data.frame(counts), transparency = 0.3, grid.col=grid.col) # no tradeoff data?
# title(paste0("Tradeoffs (n=",length(aid)," articles, x=",nrow()," cases)"),line=-3.5)
chordDiagram(as.data.frame(cbnrm.counts.syn), transparency = 0.3, grid.col=grid.col)
title("Synergies (n=8 articles, x=21 cases)",line=-3.5)
chordDiagram(as.data.frame(cbnrm.counts.both), transparency = 0.3, grid.col=grid.col)
title("Both (n=8 articles, x=21 cases)",line=-3.5)
mtext("STE by outcome domain type in CBNRM",outer=TRUE,cex=1.5)
#dev.off()
```
### Treemapping
```{r eval=T}
#Treemapping to look at outcome subtypes within outcome domains
outcomes <- select(data,aid,oid,Int_type,Out_type,Out_subtype)
foo <- data.frame(do.call('rbind', strsplit(as.character(outcomes$Out_subtype),', ',fixed=TRUE)))
outcomes2 <- outcomes %>% 
  bind_cols(foo) %>% 
  select(-Out_subtype) %>% 
  gather("X","Out_subtype", X1:X6) %>% 
  select(-X) %>% 
  distinct()
mpa_out <- filter(outcomes2,Int_type == "MPA") %>% select(oid,Out_type,Out_subtype)
cbnrm_out <- filter(outcomes2,Int_type == "CBNRM")
cbnrm_mpa_out <- filter(outcomes2,Int_type == "CBNRM_MPA")
mpa_tree_count <- count(mpa_out,Out_type,Out_subtype)
cbnrm_tree_count <- count(cbnrm_out,Out_type,Out_subtype)
cbnrm_mpa_tree_count <- count(cbnrm_mpa_out,Out_type,Out_subtype)

#pdf(file=paste0(datadir,"Outcome_attr_by_domain_MPA.pdf"))
treemap(mpa_tree_count,index=c("Out_type","Out_subtype"),
        vSize="n",
        type="index",
        fontsize.labels = c(15,10),
        fontcolor.labels=c("white","black"),
        fontface.labels=c(2,1),
        bg.labels=c("transparent"),
        align.labels=list(
          c("center","top"),
          c("left","bottom")
        ),
        overlap.labels=0.5,
        inflate.labels=F,
        title="MPAs")
# dev.off()
# pdf(file=paste0(datadir,"Outcome_attr_by_domain_CBNRM.pdf"))
treemap(cbnrm_tree_count,index=c("Out_type","Out_subtype"),
        vSize="n",
        type="index",
        fontsize.labels = c(15,10),
        fontcolor.labels=c("white","black"),
        fontface.labels=c(2,1),
        bg.labels=c("transparent"),
        align.labels=list(
          c("center","top"),
          c("left","bottom")
        ),
        overlap.labels=0.5,
        inflate.labels=F,
        title="CBNRM")
# dev.off()

# pdf(file=paste0(datadir,"Outcome_attr_by_domain_CBNRM_MPA.pdf"))
treemap(cbnrm_mpa_tree_count,index=c("Out_type","Out_subtype"),
        vSize="n",
        type="index",
        fontsize.labels = c(15,10),
        fontcolor.labels=c("white","black"),
        fontface.labels=c(2,1),
        bg.labels=c("transparent"),
        align.labels=list(
          c("center","top"),
          c("left","bottom")
        ),
        overlap.labels=0.5,
        inflate.labels=F,
        title="CBNRM_MPA")
#dev.off()
```

### Values over time
Still need to figure out other graphs over time:

* rate of change?
* make prettier (re-order by value)
```{r eval=T}
demographic_ste <- c("STE_age", "STE_econ","STE_ethnic","STE_occupation","STE_sex","STE_social")
spat_temp_ste <- c("STE_spatial","STE_temporal_unit","STE_temporal_scale")
pub_per_yr <-data %>%
  select(aid,Pub_year) %>% 
  group_by(Pub_year) %>% 
  summarise(pub_per_yr= n_distinct(aid))
STE_time <-  data %>%
  select(aid,Pub_year,STE_domain:STE_temporal_scale) %>% 
  mutate(STE_demogr = ifelse(rowSums(!is.na(.[demographic_ste]))>0,"1",NA),
         STE_spatial_temp= ifelse(rowSums(!is.na(.[spat_temp_ste]))>0,"1",NA)) %>% 
  gather("STE_type","val",STE_domain:STE_spatial_temp) %>% 
  filter(!is.na(val)) %>% 
  group_by(Pub_year,STE_type) %>% 
  summarise(ste_per_yr= n_distinct(aid)) %>% 
  left_join(pub_per_yr,by="Pub_year")  %>% 
  spread(STE_type,value = ste_per_yr) %>% 
  mutate_at(vars(pub_per_yr:STE_temporal_unit),funs(replace(., is.na(.), 0))) %>% 
  ungroup() %>% 
  arrange(Pub_year) %>% 
  mutate_at(vars(pub_per_yr:STE_temporal_unit),funs(cumsum(.))) 
tail(STE_time)

# # By intervention
# pub_per_yr_int <-data %>%
#   select(aid,Int_type,Pub_year) %>% 
#   group_by(Pub_year,Int_type) %>% 
#   summarise(pub_per_yr= n_distinct(aid,Int_type))
# STE_time_int <-  data %>%
#   select(aid,Pub_year,Int_type,STE_domain:STE_temporal_scale) %>% 
#   mutate(STE_demogr = ifelse(rowSums(!is.na(.[demographic_ste]))>0,"1",NA),
#          STE_spatial_temp= ifelse(rowSums(!is.na(.[spat_temp_ste]))>0,"1",NA)) %>% 
#   gather("STE_type","val",STE_domain:STE_spatial_temp) %>% 
#   filter(!is.na(val)) %>% 
#   group_by(Pub_year,Int_type,STE_type) %>% 
#   summarise(ste_per_yr= n_distinct(aid,Int_type)) %>% 
#   left_join(pub_per_yr_int,by=c("Pub_year","Int_type"))  %>% 
#  # unite(Int_pub,Int_type,pub_per_yr,sep = "_",remove = F) %>% 
#   unite(Int_STE,Int_type,STE_type,sep = "_",remove = F) %>% 
#   spread(Int_STE,value = ste_per_yr) %>% 
#   mutate_at(vars(pub_per_yr:MPA_STE_temporal_unit),funs(replace(., is.na(.), 0))) %>% 
#   ungroup(Pub_year) %>% 
#   arrange(Int_type,Pub_year) %>% 
#   mutate_at(vars(pub_per_yr:MPA_STE_temporal_unit),funs(cumsum(.))) 
# head(STE_time_int)
# names(STE_time_int)
# sum(STE_time$STE_demogr);sum(STE_time$STE_spatial_temp)
# 

pSTE_domain <- ggplot(STE_time,aes(x = Pub_year, y=STE_domain)) +
    ylab("Frequency") + scale_x_continuous(name="Year", breaks=seq(1990,2020,5)) +
    ggtitle('Domain')+ylim(c(0,60))+geom_line(aes(y = STE_domain))
pSTE_econ <- ggplot(STE_time,aes(x = Pub_year, y=STE_econ)) +
    ylab("Frequency") + scale_x_continuous(name="Year", breaks=seq(1990,2020,5)) +
    ggtitle('Econ gp')+ylim(c(0,40))+geom_line(aes(y = STE_econ))
pSTE_social <- ggplot(STE_time,aes(x = Pub_year, y=STE_social)) +
    ylab("Frequency") + scale_x_continuous(name="Year", breaks=seq(1990,2020,5)) +
    ggtitle('socialgp')+ylim(c(0,40))+geom_line(aes(y = STE_social))
pSTE_sex <- ggplot(STE_time,aes(x = Pub_year, y=STE_sex)) +
    ylab("Frequency") + scale_x_continuous(name="Year", breaks=seq(1990,2020,5)) +
    ggtitle('sex')+ylim(c(0,40))+geom_line(aes(y = STE_sex))
pSTE_ethnic <- ggplot(STE_time,aes(x = Pub_year, y=STE_ethnic)) +
    ylab("Frequency") + scale_x_continuous(name="Year", breaks=seq(1990,2020,5)) +
    ggtitle('ethnicgp')+ylim(c(0,40))+geom_line(aes(y = STE_ethnic))
pSTE_age <- ggplot(STE_time,aes(x = Pub_year, y=STE_age)) +
    ylab("Frequency") + scale_x_continuous(name="Year", breaks=seq(1990,2020,5)) +
    ggtitle('age')+ylim(c(0,40))+geom_line(aes(y = STE_age))
pSTE_occupation <- ggplot(STE_time,aes(x = Pub_year, y=STE_occupation)) +
    ylab("Frequency") + scale_x_continuous(name="Year", breaks=seq(1990,2020,5)) +
    ggtitle('occupation')+ylim(c(0,40))+geom_line(aes(y = STE_occupation))
pSTE_social_org <- ggplot(STE_time,aes(x = Pub_year, y=STE_social_org)) +
    ylab("Frequency") + scale_x_continuous(name="Year", breaks=seq(1990,2020,5)) +
    ggtitle('organization')+ylim(c(0,40))+geom_line(aes(y = STE_social_org))
pSTE_spatial <- ggplot(STE_time,aes(x = Pub_year, y=STE_spatial)) +
    ylab("Frequency") + scale_x_continuous(name="Year", breaks=seq(1990,2020,5)) +
    ggtitle('spatial_units')+ylim(c(0,40))+geom_line(aes(y = STE_spatial))
pSTE_temporal_unit <- ggplot(STE_time,aes(x = Pub_year, y=STE_temporal_unit)) +
    ylab("Frequency") + scale_x_continuous(name="Year", breaks=seq(1990,2020,5)) +
    ggtitle('temporal_units')+ylim(c(0,40))+geom_line(aes(y = STE_temporal_unit))
pSTE_temporal_scale <- ggplot(STE_time,aes(x = Pub_year, y=STE_temporal_scale)) +
    ylab("Frequency") + scale_x_continuous(name="Year", breaks=seq(1990,2020,5)) +
    ggtitle('temporal_scale')+ylim(c(0,40))+geom_line(aes(y = STE_temporal_scale))
pSTE_demo <- ggplot(STE_time,aes(x = Pub_year, y=STE_demo)) +
    ylab("Frequency") + scale_x_continuous(name="Year", breaks=seq(1990,2020,5)) +
    ggtitle('Demographic')+ylim(c(0,100))+geom_line(aes(y = STE_demogr))
pSTE_spatial_temp <- ggplot(STE_time,aes(x = Pub_year, y=STE_spatial_temp)) +
    ylab("Frequency") + scale_x_continuous(name="Year", breaks=seq(1990,2020,5)) +
    ggtitle('Spatio-temporal')+ylim(c(0,60))+geom_line(aes(y = STE_spatial_temp))

plot_grid(pSTE_domain, pSTE_econ,pSTE_social,pSTE_sex,
          pSTE_ethnic,pSTE_age,pSTE_occupation,
          pSTE_spatial,pSTE_temporal_unit,pSTE_temporal_scale,
          labels=letters[1:12], ncol = 4, nrow = 3, hjust=-1)

STE_time_gps <- STE_time %>%
  select(Pub_year,pub_per_yr,STE_domain,STE_demogr,STE_spatial_temp) %>%
  gather("STE_gp","val",pub_per_yr:STE_spatial_temp) %>% 
  mutate(STE_gp=gsub("STE_","",STE_gp),
        STE_gp=gsub("demogr","demographic",STE_gp) )
pSTE_time_gps <- ggplot(STE_time_gps)  + 
  geom_line(aes(x = Pub_year, y = val, group = STE_gp, colour = STE_gp))  +
  ylab("Frequency") + scale_x_continuous(name="Year", breaks=seq(1985,2025,5)) +
  ggtitle('Groups')+ylim(c(0,100)) 
 # direct.label(pSTE_time_gps,list(cex=1.5, "last.qp"))

 
# Growth by intervention
Int_time_gps <-  data %>%
  group_by(Pub_year,Int_type) %>% 
  summarise(int_per_yr= n_distinct(aid)) %>% 
  spread(Int_type,value = int_per_yr) %>% 
  mutate_at(vars(CBNRM:MPA),funs(replace(., is.na(.), 0))) %>% 
  ungroup() %>% 
  arrange(Pub_year) %>% 
  mutate_at(vars(CBNRM:MPA),funs(cumsum(.))) %>% 
  gather("int_typ","val",CBNRM:MPA) 
tail(Int_time_gps)
pInt_time_gps <- ggplot(Int_time_gps)  + 
  geom_line(aes(x = Pub_year, y = val, group = int_typ, colour = int_typ))  +
  ylab("Frequency") + scale_x_continuous(name="Year", breaks=seq(1985,2025,5)) +
  ggtitle('Intervention type')+ylim(c(0,60)) 
 # direct.label(pSTE_time_gps,list(cex=1.5, "last.qp"))

# Growth by STE (demographic group)
STE_time_demog <- STE_time %>%
  select(Pub_year,STE_age,STE_econ,STE_ethnic,STE_occupation,STE_sex,STE_social) %>%
  gather("STE_gp","val",STE_age:STE_social) %>% 
  mutate(STE_gp=gsub("STE_","",STE_gp))
pSTE_time_demog <-  ggplot(STE_time_demog)  + 
  geom_line(aes(x = Pub_year, y = val, group = STE_gp, colour = STE_gp))  +
  ylab("Frequency") + scale_x_continuous(name="Year", breaks=seq(1985,2025,5)) +
  ggtitle('Demographic groups')+ylim(c(0,60)) 
 # direct.label(pSTE_time_gps,list(cex=1.5, "last.qp"))

# Growth by domain
STE_time_dom <-  data %>%
  filter(!is.na(STE_domain)) %>% 
  group_by(Pub_year,Out_type) %>% 
  summarise(dom_per_yr= n_distinct(aid))   %>%
  spread(Out_type,value = dom_per_yr) %>% 
  mutate_at(vars(Culture:`Social capital`),funs(replace(., is.na(.), 0))) %>% 
  ungroup() %>% 
  arrange(Pub_year) %>% 
  mutate_at(vars(Culture:`Social capital`),funs(cumsum(.))) %>% 
  gather("out_typ","val",Culture:`Social capital`) 
tail(STE_time_dom)
pSTE_time_dom <- ggplot(STE_time_dom)  + 
  geom_line(aes(x = Pub_year, y = val, group = out_typ, colour = out_typ))  +
  ylab("Frequency") + scale_x_continuous(name="Year", breaks=seq(1985,2025,5)) +
  ggtitle('Domain')+ylim(c(0,60)) 
 # direct.label(pSTE_time_gps,list(cex=1.5, "last.qp"))

# Growth by scale
STE_scale_gps <- STE_time %>%
  select(Pub_year,STE_spatial,STE_temporal_scale,STE_temporal_unit) %>%
  gather("STE_gp","val",STE_spatial:STE_temporal_unit) %>% 
  mutate(STE_gp=gsub("STE_","",STE_gp))
pSTE_scale_gps <- ggplot(STE_scale_gps)  + 
  geom_line(aes(x = Pub_year, y = val, group = STE_gp, colour = STE_gp))  +
  ylab("Frequency") + scale_x_continuous(name="Year", breaks=seq(1985,2025,5)) +
  ggtitle('Scale')+ylim(c(0,60)) 
 # direct.label(pSTE_time_gps,list(cex=1.5, "last.qp"))

plot_grid(pInt_time_gps, pSTE_time_demog,pSTE_time_dom,pSTE_scale_gps,
          labels=letters[1:4], ncol = 2, nrow = 2, hjust=-1)



# STE_time_percent <-ext.data %>%
#   filter(exclude=='FALSE') %>% 
#   select(aid,Pub_year,STE_domain:STE_temporal_scale) %>%  # replace to your needs
#   group_by(aid,Pub_year) %>% 
#   summarise_all(funs(sum(!is.na(.))))  %>% 
#   arrange(Pub_year) %>% 
#   ungroup() %>% 
#   add_count(Pub_year) %>% 
#   rename(num.articles=n) %>% 
#   mutate_at(vars(STE_domain:STE_temporal_scale),funs(ifelse(.>0,1,0))) %>% 
#   group_by(Pub_year,num.articles) %>% 
#   summarise_at(vars(STE_domain:STE_temporal_scale),funs(sum)) %>% 
#   transmute_at(vars(STE_domain:STE_temporal_scale),funs(./num.articles))
# head(STE_time_percent)
# 
# pSTE_domain <- ggplot(STE_time_percent,aes(x = Pub_year, y=STE_domain)) +
#     ylab("Frequency") + scale_x_continuous(name="Year", breaks=seq(1990,2020,5)) +
#     ggtitle('Domain')+ylim(c(0,20))+geom_line(aes(y = cumsum(STE_domain)))
# pSTE_econ <- ggplot(STE_time_percent,aes(x = Pub_year, y=STE_econ)) +
#     ylab("Frequency") + scale_x_continuous(name="Year", breaks=seq(1990,2020,5)) +
#     ggtitle('Econ gp')+ylim(c(0,20))+geom_line(aes(y = cumsum(STE_econ)))
# pSTE_social <- ggplot(STE_time_percent,aes(x = Pub_year, y=STE_social)) +
#     ylab("Frequency") + scale_x_continuous(name="Year", breaks=seq(1990,2020,5)) +
#     ggtitle('socialgp')+ylim(c(0,20))+geom_line(aes(y = cumsum(STE_social)))
# pSTE_sex <- ggplot(STE_time_percent,aes(x = Pub_year, y=STE_sex)) +
#     ylab("Frequency") + scale_x_continuous(name="Year", breaks=seq(1990,2020,5)) +
#     ggtitle('sex')+ylim(c(0,20))+geom_line(aes(y = cumsum(STE_sex)))
# pSTE_ethnic <- ggplot(STE_time_percent,aes(x = Pub_year, y=STE_ethnic)) +
#     ylab("Frequency") + scale_x_continuous(name="Year", breaks=seq(1990,2020,5)) +
#     ggtitle('ethnicgp')+ylim(c(0,20))+geom_line(aes(y = cumsum(STE_ethnic)))
# pSTE_age <- ggplot(STE_time_percent,aes(x = Pub_year, y=STE_age)) +
#     ylab("Frequency") + scale_x_continuous(name="Year", breaks=seq(1990,2020,5)) +
#     ggtitle('age')+ylim(c(0,20))+geom_line(aes(y = cumsum(STE_age)))
# pSTE_social_org <- ggplot(STE_time_percent,aes(x = Pub_year, y=STE_social_org)) +
#     ylab("Frequency") + scale_x_continuous(name="Year", breaks=seq(1990,2020,5)) +
#     ggtitle('occupation')+ylim(c(0,20))+geom_line(aes(y = cumsum(STE_social_org)))
# pSTE_organization <- ggplot(STE_time_percent,aes(x = Pub_year, y=STE_organization)) +
#     ylab("Frequency") + scale_x_continuous(name="Year", breaks=seq(1990,2020,5)) +
#     ggtitle('organizationp')+ylim(c(0,20))+geom_line(aes(y = cumsum(STE_organization)))
# pSTE_spatial_units <- ggplot(STE_time_percent,aes(x = Pub_year, y=STE_spatial_units)) +
#     ylab("Frequency") + scale_x_continuous(name="Year", breaks=seq(1990,2020,5)) +
#     ggtitle('spatial_units')+ylim(c(0,20))+geom_line(aes(y = cumsum(STE_spatial_units)))
# pSTE_temporal_units <- ggplot(STE_time_percent,aes(x = Pub_year, y=STE_temporal_units)) +
#     ylab("Frequency") + scale_x_continuous(name="Year", breaks=seq(1990,2020,5)) +
#     ggtitle('temporal_units')+ylim(c(0,20))+geom_line(aes(y = cumsum(STE_temporal_units)))
# pSTE_temporal_scale <- ggplot(STE_time_percent,aes(x = Pub_year, y=STE_temporal_scale)) +
#     ylab("Frequency") + scale_x_continuous(name="Year", breaks=seq(1990,2020,5)) +
#     ggtitle('temporal_scale')+ylim(c(0,20))+geom_line(aes(y = cumsum(STE_temporal_scale)))
# 
# plot_grid(pSTE_domain, pSTE_econ,pSTE_social,pSTE_sex,
#           pSTE_ethnic,pSTE_age,pSTE_social_org,pSTE_organization,
#           pSTE_spatial_units,pSTE_temporal_units,pSTE_temporal_scale,
#           labels=letters[1:12], ncol = 4, nrow = 3, hjust=-1)
# ggsave(paste0(datadir,'STE over time_percent.jpg'),width = 13,height = 7)
# 
# # By year and intervention
# STE_time_int <-ext.data %>%
#   filter(exclude=='FALSE') %>% 
#   select(aid,Pub_year,int_typ,STE_domain:STE_temporal_scale) %>%  # replace to your needs
#   group_by(aid,Pub_year,int_typ) %>% 
#   summarise_all(funs(sum(!is.na(.))))  %>% 
#   arrange(Pub_year) %>% 
#   ungroup() %>% 
#   add_count(Pub_year,int_typ) %>% 
#   rename(num.articles=n) %>% 
#   mutate_at(vars(STE_domain:STE_temporal_scale),funs(ifelse(.>0,1,0))) %>% 
# #  mutate_at(vars(STE_domain:STE_temporal_scale),funs(./num.articles)) %>% 
#   group_by(Pub_year,int_typ,num.articles) %>% 
#   summarise_at(vars(STE_domain:STE_temporal_scale),funs(sum)) %>% 
#   gather(key=dimension,value=val,STE_domain:STE_temporal_scale) 
# #  filter(val>0)
# View(STE_time_int)
# 
# STE_time_int %>% 
#   filter(dimension=='STE_domain' & val>0) %>% pull(Pub_year) 
# 
# ggplot(filter(STE_time_int,dimension=='STE_domain'),aes(x = Pub_year, y=val,fill=int_typ,alpha=0.5)) +
#     ylab("Frequency") + scale_x_continuous(name="Year", breaks=seq(1990,2020,5)) +
#     ggtitle('Domain')+ylim(c(0,20))+geom_area(aes(y = cumsum(val)),position = "identity") 
# 
# pSTE_domain <- ggplot(STE_time_int,aes(x = Pub_year, y=STE_domain,fill=int_typ,alpha=0.5)) +
#     ylab("Frequency") + scale_x_continuous(name="Year", breaks=seq(1990,2020,5)) +
#     ggtitle('Domain')+ylim(c(0,60))+geom_area(aes(y = cumsum(STE_domain)),position = "identity")
# pSTE_econ <- ggplot(STE_time_int,aes(x = Pub_year, y=STE_econ,fill=int_typ,alpha=0.5)) +
#     ylab("Frequency") + scale_x_continuous(name="Year", breaks=seq(1990,2020,5)) +
#     ggtitle('Econgp')+ylim(c(0,40))+geom_area(aes(y = cumsum(STE_econ)),position = "identity")
# pSTE_social <- ggplot(STE_time_int,aes(x = Pub_year, y=STE_social,fill=int_typ,alpha=0.5)) +
#     ylab("Frequency") + scale_x_continuous(name="Year", breaks=seq(1990,2020,5)) +
#     ggtitle('Socialgp')+ylim(c(0,40))+geom_area(aes(y = cumsum(STE_social)),position = "identity")
# pSTE_sex <- ggplot(STE_time_int,aes(x = Pub_year, y=STE_sex,fill=int_typ,alpha=0.5)) +
#     ylab("Frequency") + scale_x_continuous(name="Year", breaks=seq(1990,2020,5)) +
#     ggtitle('sex')+ylim(c(0,40))+geom_area(aes(y = cumsum(STE_sex)),position = "identity")
# pSTE_ethnic <- ggplot(STE_time_int,aes(x = Pub_year, y=STE_ethnic,fill=int_typ,alpha=0.5)) +
#     ylab("Frequency") + scale_x_continuous(name="Year", breaks=seq(1990,2020,5)) +
#     ggtitle('ethnicgp')+ylim(c(0,40))+geom_area(aes(y = cumsum(STE_ethnic)),position = "identity")
# pSTE_age <- ggplot(STE_time_int,aes(x = Pub_year, y=STE_age,fill=int_typ,alpha=0.5)) +
#     ylab("Frequency") + scale_x_continuous(name="Year", breaks=seq(1990,2020,5)) +
#     ggtitle('age')+ylim(c(0,40))+geom_area(aes(y = cumsum(STE_age)),position = "identity")
# pSTE_social_org <- ggplot(STE_time_int,aes(x = Pub_year, y=STE_social_org,fill=int_typ,alpha=0.5)) +
#     ylab("Frequency") + scale_x_continuous(name="Year", breaks=seq(1990,2020,5)) +
#     ggtitle('occupation')+ylim(c(0,40))+geom_area(aes(y = cumsum(STE_social_org)),position = "identity")
# pSTE_organization <- ggplot(STE_time_int,aes(x = Pub_year, y=STE_organization,fill=int_typ,alpha=0.5)) +
#     ylab("Frequency") + scale_x_continuous(name="Year", breaks=seq(1990,2020,5)) +
#     ggtitle('organizationp')+ylim(c(0,40))+geom_area(aes(y = cumsum(STE_organization)),position = "identity")
# pSTE_spatial_units <- ggplot(STE_time_int,aes(x = Pub_year, y=STE_spatial_units,fill=int_typ,alpha=0.5)) +
#     ylab("Frequency") + scale_x_continuous(name="Year", breaks=seq(1990,2020,5)) +
#     ggtitle('spatial_units')+ylim(c(0,40))+geom_area(aes(y = cumsum(STE_spatial_units)),position = "identity")
# pSTE_temporal_units <- ggplot(STE_time_int,aes(x = Pub_year, y=STE_temporal_units,fill=int_typ,alpha=0.5)) +
#     ylab("Frequency") + scale_x_continuous(name="Year", breaks=seq(1990,2020,5)) +
#     ggtitle('temporal_units')+ylim(c(0,40))+geom_area(aes(y = cumsum(STE_temporal_units)),position = "identity")
# pSTE_temporal_scale <- ggplot(STE_time_int,aes(x = Pub_year, y=STE_temporal_scale,fill=int_typ,alpha=0.5)) +
#     ylab("Frequency") + scale_x_continuous(name="Year", breaks=seq(1990,2020,5)) +
#     ggtitle('temporal_scale')+ylim(c(0,40))+geom_area(aes(y = cumsum(STE_temporal_scale)),position = "identity")
# 
# plot_grid(pSTE_domain + theme(legend.position="none"), 
#           pSTE_econ + theme(legend.position="none"),
#           pSTE_social + theme(legend.position="none"),
#           pSTE_sex + theme(legend.position="none"),
#           pSTE_ethnic + theme(legend.position="none"),
#           pSTE_age + theme(legend.position="none"), 
#           pSTE_social_org + theme(legend.position="none"),
#           pSTE_organization + theme(legend.position="none"),
#           pSTE_spatial_units + theme(legend.position="none"),
#           pSTE_temporal_units + theme(legend.position="none"),
#           pSTE_temporal_scale,
#           labels=letters[1:12], ncol = 4, nrow = 3, hjust=-1)
# ggsave(paste0(datadir,'STE over time_intervention.jpg'),width = 18,height = 10)

# Interventions over time
minyr <- min(data$Pub_year)-1;maxyr <- max(data$Pub_year)+1
pInt_time <- data %>% 
  group_by(aid,Pub_year,Int_type) %>% 
  summarise(num=n_distinct(aid)) %>%
  arrange(Pub_year) %>% 
  ungroup() %>% 
  ggplot(aes(x=Pub_year)) +
  geom_bar(aes(fill = Int_type)) +
  scale_x_continuous("Publyear", breaks=seq(minyr,maxyr,5)) 

pStudy_typ_time <- data %>% 
  group_by(aid,Pub_year,Study_type) %>% 
  summarise(num=n_distinct(aid)) %>%
  arrange(Pub_year) %>% 
  ungroup() %>% 
  ggplot(aes(x=Pub_year)) +
  geom_bar(aes(fill = Study_type)) +
  scale_x_continuous("Study type", breaks=seq(minyr,maxyr,5)) 

plot_grid(pInt_time+theme(legend.position="right"), pStudy_typ_time+theme(legend.position="right"),
          labels=letters[1:2], ncol = 1, nrow = 2, hjust=-1)
```

### Export plots
```{r, EVAL =F}
#-- Intervention & study plots
## about study
plot_grid(pExclude,pPubyr,pPubtype,pAuth_aff,
          labels=letters[1:4], ncol = 2, nrow = 2, hjust=-1)
ggsave(paste0(datadir,'STE pub info.jpg'),width = 10.5,height = 6)
## about intervention
plot_grid(pInt_typ,pInt_scale,pBiome,pCountry
          ,labels=letters[1:4], ncol = 2, nrow = 2, hjust=-1)
ggsave(paste0(datadir,'STE intervention info.jpg'),width = 14,height = 9)
## about study
plot_grid(pStudy_typ,pStdy_source,pStdy_scl,pCtrl_gp,pCtrl_typ,
          labels=letters[1:5], ncol = 3, nrow = 2, hjust=-1)
ggsave(paste0(datadir,'STE study info.jpg'),width = 10.5,height = 6)
## outcomes
plot_grid(pDatatype,pDataobs,pOut_domain, pSTE,labels=letters[1:4], 
          ncol = 2, nrow = 2, hjust=-1)
ggsave(paste0(datadir,'STE outcome summaries.jpg'),width = 10.5,height = 6)

#-- World map
pdf(file=paste0(datadir,"STE_Country_Map_dark_5_11.pdf"), width=16, height=8.5)
ggplot() +
  geom_map(data=countries_only, aes(map_id=Code, fill=counts),map=map) +
  geom_map(data=countries_zero, aes(map_id=Code),fill="#f0f0f0",map=map) +
  expand_limits(x=map$long,y=map$lat) +
  theme(panel.background = element_rect(fill = "darkgray", colour = "darkgray"), panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  scale_fill_gradient2(low="#f7fbff",mid="#6baed6",high="#08306b",midpoint=(max(countries_only$counts)/2),limits=c(0,max(countries_only$counts)))
dev.off()

#-- Heat maps
## all outcomes combined
pdf(file=paste0(datadir,"STE_Int_Outcome_Heatmap_articles_test.pdf"), width=11, height=8.5)
heat.map.all
dev.off()
## all outcomes by intervention
pdf(file=paste0(datadir,"STE_type_Int_Outcome_Heatmap_5_11.pdf"), width=11, height=8.5)
heat.map.int
dev.off()

#-- Chord diagrams
## MPA
pdf(file=paste0(datadir,"STE by Domain - MPA_4_24.pdf"),width=11,height=8.5)
par(mfrow=c(1,2),oma=c(0,0,2,0))
chordDiagram(as.data.frame(mpa.counts.trdoff), transparency = 0.3, grid.col=grid.col)
title("Tradeoffs (n=16 articles, x=46 cases)",line=-3.5)
chordDiagram(as.data.frame(mpa.counts.both), transparency = 0.3, grid.col=grid.col)
title("Both (n=16 articles, x=46 cases)",line=-3.5)
chordDiagram(as.data.frame(mpa.counts.syn), transparency = 0.3, grid.col=grid.col)
title("Synergies (n=26 articles, x=70 cases)",line=-3.5)
mtext("STE by outcome domain type in MPAs",outer=TRUE,cex=1.5)
dev.off()
## CBRNRM
pdf(file=paste0(datadir,"STE by Domain - CBNRM_4_24.pdf"),width=11,height=8.5)
par(mfrow=c(1,2),oma=c(0,0,2,0))
# chordDiagram(as.data.frame(counts), transparency = 0.3, grid.col=grid.col) # no tradeoff data?
# title(paste0("Tradeoffs (n=",length(aid)," articles, x=",nrow()," cases)"),line=-3.5)
chordDiagram(as.data.frame(cbnrm.counts.syn), transparency = 0.3, grid.col=grid.col)
title("Synergies (n=8 articles, x=21 cases)",line=-3.5)
chordDiagram(as.data.frame(cbnrm.counts.both), transparency = 0.3, grid.col=grid.col)
title("Both (n=8 articles, x=21 cases)",line=-3.5)
mtext("STE by outcome domain type in CBNRM",outer=TRUE,cex=1.5)
dev.off()

#-- Tree maps
## MPA
pdf(file=paste0(datadir,"Outcome_attr_by_domain_MPA.pdf"))
treemap(mpa_tree_count,index=c("Out_type","Out_subtype"),
        vSize="n",
        type="index",
        fontsize.labels = c(15,10),
        fontcolor.labels=c("white","black"),
        fontface.labels=c(2,1),
        bg.labels=c("transparent"),
        align.labels=list(
          c("center","top"),
          c("left","bottom")
        ),
        overlap.labels=0.5,
        inflate.labels=F,
        title="MPAs")
dev.off()

## CBNRM
pdf(file=paste0(datadir,"Outcome_attr_by_domain_CBNRM.pdf"))
treemap(cbnrm_tree_count,index=c("Out_type","Out_subtype"),
        vSize="n",
        type="index",
        fontsize.labels = c(15,10),
        fontcolor.labels=c("white","black"),
        fontface.labels=c(2,1),
        bg.labels=c("transparent"),
        align.labels=list(
          c("center","top"),
          c("left","bottom")
        ),
        overlap.labels=0.5,
        inflate.labels=F,
        title="CBNRM")
dev.off()
## CBNRM_MPA
pdf(file=paste0(datadir,"Outcome_attr_by_domain_CBNRM_MPA.pdf"))
treemap(cbnrm_mpa_tree_count,index=c("Out_type","Out_subtype"),
        vSize="n",
        type="index",
        fontsize.labels = c(15,10),
        fontcolor.labels=c("white","black"),
        fontface.labels=c(2,1),
        bg.labels=c("transparent"),
        align.labels=list(
          c("center","top"),
          c("left","bottom")
        ),
        overlap.labels=0.5,
        inflate.labels=F,
        title="CBNRM_MPA")
dev.off()

# STE over time
plot_grid(pSTE_domain, pSTE_econ,pSTE_social,pSTE_sex,
          pSTE_ethnic,pSTE_age,pSTE_occupation,
          pSTE_spatial,pSTE_temporal_unit,pSTE_temporal_scale,
          labels=letters[1:12], ncol = 4, nrow = 3, hjust=-1)
ggsave(paste0(datadir,'STE over time.jpg'),width = 13,height = 7)

# study over time
plot_grid(pInt_time+theme(legend.position="right"), pStudy_typ_time+theme(legend.position="right"),
          labels=letters[1:2], ncol = 1, nrow = 2, hjust=-1)
ggsave(paste0(datadir,'study over time.jpg'),width = 10.5,height = 6)

# main groups over time
plot_grid(pInt_time_gps, pSTE_time_demog,pSTE_time_dom,pSTE_scale_gps,
          labels=letters[1:4], ncol = 2, nrow = 2, hjust=-1)

ggsave(paste0(datadir,'growth_over_time.jpg'),width = 13,height = 7)


```