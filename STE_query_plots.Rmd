---
title: "STE_query_plots"
author: "Sam Cheng, David Gill"
date: "May 14, 2018"
output: html_document
---
##Setup
load packages, set file directories
```{r}
# first time install for waffle package, ggplot with sf
# library(devtools)
# install_github("hrbrmstr/waffle")
# font_import()
#devtools::install_github("tidyverse/ggplot2")


extrafont::loadfonts(device="win")
library(gplots)
library(RColorBrewer)
library(viridis)
library(extrafont)
library(ggthemes)
library(d3Network)
library(treemap)
library(maptools)
library(rio)
library(circlize)
library(waffle)
library(sf)
library(cowplot)
library(ggplot2)
library(tidyverse)


# setwd("~/Documents/github/marine_ste/")
# map_data_final <- readRDS("data/map_data_final_4_24.rds")
# load("data/STE_Evidence_Map_2_10_2018.RData")

# Directories
pcdir <- gsub("Dropbox.*","",getwd())
dropbox <- paste0(pcdir,"Dropbox/SynergiesTradeoffs.Review/Data extraction/")
datadir <- paste0(pcdir,"Dropbox/data/analysis/STEreview/")
outputdir <- paste0(pcdir,"Dropbox/SynergiesTradeoffs.Review/Data extraction/updated_plots/")

# Projections
wgs84 <- CRS("+proj=longlat +ellps=WGS84")

# Custom summary and plot functions
source("my_summary_plot_functions.R")


### Read in and prep data
country <- import(paste0(datadir,"allcountries.csv"))
ext.table <- import(paste0(dropbox,'STE extracted results to date.xlsx'), sheet = 1) 
# paste0('Are article and outcome exclusion values are identical? ',identical(ext.table$`05 Exclude`,ext.table$`40 Exclude`))
# if (!identical(ext.table$`05 Exclude`,ext.table$`40 Exclude`)){
#   View(ext.table[ext.table$`05 Exclude`!=ext.table$`40 Exclude`,])
#   ext.table <- ext.table[ext.table$`05 Exclude`==ext.table$`40 Exclude`,]
# }

names(ext.table) <- gsub(" ","_",names(ext.table))
ext.data <- ext.table %>% 
  rename(aid='Data_extraction_questionnaire.01_Article_ID',
         Assessor="02_Name_of_Assessor",
         Assess_date="04_Date_of_assessment",
         exclude='05_Exclude',
         Pub_type='11_Publication_type',
         Authors="12_Author",
         Pub_year='13_Year_of_publication',
         Title="14_Title",
         Journal='15_Journal', 
         source='110_Source', 
         auth_aff_addr='16_Affiliation_of_first_author',
         auth_aff='17_Affiliation_type_of_first_author',
         Funding="18_Funding_source",
         DOI="19_DOI",
         Source="110_Source",
         Bib_notes="111_notes_on_bibliography",
         Int_type='22_Type_of_intervention',
         int_scale='24_Geographic_scale_of_intervention',           
         int_time='25_Timeframe_of_intervention',           
         int_auth='27_Managing_authority',           
         Int_location='28_Intervention_location',           
         Int_area='29_Intevention_area',
         Stated_int="21_Stated_intervention",
         Desired_out="23_Desired_outcome_of_intervention",
         Int_dur="25_Timeframe_of_intervention",
         Int_funding="26_Funding_source",
         Int_notes="210_notes_on_intervention",
         Study_goal="31_Stated_goal_of_the_study",
         Study_type='32_Study_type',
         Design.control_comp='33_Study_includes_a_comparison/control_group',
         Comp_type='34_Type_of_comparison_(control_group)',
         Data_source='35_Data_source',
         Study_location="36_Location_of_study",
         Study_country='37_Country_of_study',
         stdy_scl='38_Study_scale',           
         Biome.='39_Biome', 
         eval_aff='310_Affliation_of_evaluator',           
         Unit_analysis='311_Social_unit_of_analysis', 
         Sample_Size='312_Sample_size_(maximum)', 
         Study_duration='313_Duration_of_study',
         Study_notes="314_notes_on_study_type",
         Distributive_equity='51_Distributive_equity', 
         Recognitional_equity='52_Recognitional_equity', 
         Contextual_equity='53_Contextual_equity', 
         Procedural_equity='54_Procedural_equity',
         Equity_notes="55_Equity_notes",
         Causal_pathway='61_Causal_pathway/theory_of_change', 
         Explicit_mechanism='62_Explicit_mechanism', 
         Pathway_notes="63_Pathway_notes",
         oid='OutcomeID',
         outcome.exclude='40_Exclude',
         Stated_outcomes='41_Stated_outcome_measured',
         Out_type='42_Outcome_domain',
         Out_subtype='43_Outcome_attribute',
         Indicators='44_Outcome_indicator',
         Out_definition='45_Perceptions_vs_observed_outcome',
         Outcome.data_type='46_Outcome_data-type',
         Resource_type='47_Resource_use_type',
         Outcome.direction='48_Overall_outcome_direction',
         Pluralism='49_Pluralism_(who_defines_STEs?)',
         Out_subgroup='410_Outcome_sub-group',
         STE_domain='411_STE:_social_domain/HWB_outcomes',
         STE_econ='412_STE:_(economic_status)',
         STE_social='413_STE:__(social_status)',
         STE_sex='414_STE:__(sex)',
         STE_ethnic='415_STE:__(ethnic_group/race)',
         STE_age='416_STE:__(age)',           
         STE_occupation='417_STE:__(occupation)',
         STE_social_org='418_STE:_level_of_social_organization',
         STE_spatial='419_STE:_spatial_units',
         STE_temporal_unit='420_STE:_temporal_units',
         STE_temporal_scale='421_STE:_temporal_scales', 
         Outcome_notes="422_Outcome_notes" 
  )

# remove open-ended or unneeded variables, spread multi-choice variables
unwanted.var <- grep('(\\d)',names(ext.data),value = T) # variables that still contain a number in the name
data <- ext.data %>% 
  select(-one_of(unwanted.var)) %>%
  mutate(Comp_type=gsub("Pre-treatment/post-treatment","Pre/post treatment",Comp_type),
         Int_type=gsub("CBNRM","CBM",Int_type),
         Int_type=gsub("CBM, MPA","CBMPA",Int_type),
         Comp_type=ifelse(is.na(Comp_type),'none',Comp_type),
         Affil_type.Academic=ifelse(grepl("Academic",auth_aff),1,0),
         Affil_type.Public_sector=ifelse(grepl("Public",auth_aff),1,0),
         Affil_type.Research_Institute=ifelse(grepl("Research",auth_aff),1,0),
         Affil_type.Consultant=ifelse(grepl("Consultant",auth_aff),1,0),
         Affil_type.Non_profit=ifelse(grepl("profit",auth_aff),1,0),
         Affil_type.Private_sector=ifelse(grepl("Private",auth_aff),1,0),
         Affil_type.International_Organization=ifelse(grepl("International",auth_aff),1,0),
         Int_type.MPA=ifelse(grepl("MPA",Int_type),1,0),
         Int_type.PES=ifelse(grepl("PES",Int_type),1,0),
         Int_type.CBM=ifelse(grepl("CBM",Int_type),1,0),
         Int_type.Certification=ifelse(grepl("Certification",Int_type),1,0),
         Int_geo.local=ifelse(grepl("Local",int_scale),1,0),
         Int_geo.region=ifelse(grepl("Region",int_scale),1,0),
         Int_geo.national=ifelse(grepl("National",int_scale),1,0),
         Int_geo.subnational=ifelse(grepl("Sub-national",int_scale),1,0),
         Int_geo.international=ifelse(grepl("International",int_scale),1,0),
         Mang_auth.Government=ifelse(grepl("Government",int_auth,ignore.case = T),1,0),
         Mang_auth.Shared_governance=ifelse(grepl("shared",int_auth,ignore.case = T),1,0),
         Mang_auth.Private_governance=ifelse(grepl("private",int_auth,ignore.case = T),1,0),
         Mang_auth.Indigenous_community_governance=ifelse(grepl("Indigenous",int_auth,
                                                                ignore.case = T),1,0),
         Mang_auth.multiple=ifelse(grepl("multiple",int_auth),1,0),  
         Mang_auth.mixed=ifelse(grepl("mixed",int_auth,ignore.case = T),1,0),
         Comp_type.dist=ifelse(grepl("Distance",Comp_type),1,0),
         Comp_type.treat=ifelse(grepl("Treated/Untreated",Comp_type),1,0),
         Comp_type.prepost=ifelse(grepl("Pre/post",Comp_type),1,0),
         Comp_type.match.BACI=ifelse(grepl("Matched BACI",Comp_type),1,0),
         Comp_type.unmatch.BACI=ifelse(grepl("Unmatched BACI",Comp_type),1,0),
         Comp_type.none=ifelse(!is.na(Comp_type),1,0)) %>% 
        filter(exclude==FALSE & outcome.exclude==FALSE)
# check greps
# View(select(data,contains('Int_geo'),contains('int_scale')) %>% filter(!is.na(int_scale)))

# Author institution country
USnames <- c(" US"," USA",",US",",USA","U.S","U.S.A","Central Washington University","University of Washington",
             "World Bank","University of Rhode Island,","Arlington, VA")
UKnames <- c("UK","U.K")
CANnames <- c("British Columbia","Memorial University")
data <- data %>% 
  mutate(auth_ctry1 = str_extract(auth_aff_addr,paste(country$Country,collapse="|")),
         auth_ctry1 =ifelse(grepl(paste(USnames,collapse="|"),auth_aff_addr),"United States",auth_ctry1),
         auth_ctry1 =ifelse(grepl(paste(UKnames,collapse="|"),auth_aff_addr),"United Kingdom",auth_ctry1),
         auth_ctry1 =ifelse(grepl(paste(CANnames,collapse="|"),auth_aff_addr),"Canada",auth_ctry1),
         auth_ctry1 =ifelse(grepl("Silliman Unversity Marine Laboratory",auth_aff_addr),"Philippines",auth_ctry1),
         auth_ctry1 =ifelse(grepl("USAID/Philippine",auth_aff_addr),"Philippines",auth_ctry1),
         auth_ctry1 =ifelse(grepl("Fundacion Natura",auth_aff_addr),"Ecuador",auth_ctry1),
         auth_ctry1 =ifelse(grepl("University of Technology Srivijaya",auth_aff_addr),"Thailand",auth_ctry1),
         auth_ctry1 =ifelse(grepl("Bayero University Kano",auth_aff_addr),"Nigeria",auth_ctry1),
         auth_ctry1 =ifelse(grepl("Harvard University",auth_aff_addr),"United States",auth_ctry1),
         auth_ctry1 =ifelse(grepl("Taiwan",auth_aff_addr),"Taiwan, Province Of China",auth_ctry1),
         auth_ctry1 =ifelse(grepl("Universidade Estadual de Santa Cruz",auth_aff_addr),"Brazil",auth_ctry1),
         auth_ctry1 =ifelse(grepl("Universidad Nacional Autónoma de México",auth_aff_addr),"Mexico",auth_ctry1))  
# for double affiliation
data <- data %>% 
  mutate(auth_aff_addr1=str_replace_all(auth_aff_addr, auth_ctry1, ""),
         auth_ctry2=str_extract(auth_aff_addr1,paste(country$Country,collapse="|")),
         auth_ctry2 =ifelse(grepl("Bogor Agricultural University",auth_aff_addr1),"Indonesia",auth_ctry2),
         auth_ctry2 =ifelse(grepl("Vietnam Forestry University",auth_aff_addr1),"Viet Nam",auth_ctry2),
         auth_ctry2 =ifelse(grepl("Univer-\r\nsity of York",auth_aff_addr1),"United Kingdom",auth_ctry2),
         auth_ctry2 =ifelse(grepl("Centro Intercul",auth_aff_addr1),"Mexico",auth_ctry2),
         auth_ctry2=ifelse(auth_ctry2==auth_ctry1,"",auth_ctry2)) %>% 
         select(-auth_aff_addr1)

rm(unwanted.var,USnames,UKnames,CANnames)

###------ Basic plot functions (for next chunk of plots)

# article level stats
 ste_gp <- function (z) {
  enquo_z <- enquo(z)  # measurement variable
  # group and summarize
  data %>%
    filter(!is.na(UQ(enquo_z))) %>% 
    group_by(UQ(enquo_z)) %>% 
    summarise(num=n_distinct(aid)) %>% 
    arrange(-num) %>% 
    mutate(x.labels=ordered(UQ(enquo_z))) %>% 
    ggplot(aes(x=reorder(x.labels,num),y=num))+
    geom_bar(stat='identity', fill='blue', width = 1) +
    coord_flip()}

# outcome level stats
ste_gp_o <- function (z) {
 data %>% 
  filter(!is.na(z)) %>%
  group_by_(z) %>% 
  summarise(num=n()) %>%
  arrange(-num) }
ste_hist <- function () {
  list(
    geom_histogram(stat='identity', fill='blue'),
    coord_flip(),
    theme_bw(),
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())
  )
}

```

### Study-level plots
Intervention properties, study design, etc.
```{r eval=T}
# --------- Study information 
#Percent excluded
(pExclude <- ext.table %>% 
    rename(aid='Data_extraction_questionnaire.01_Article_ID',
         exclude='05_Exclude') %>% 
    group_by(aid,exclude) %>% 
    summarise(num=n()) %>% 
  ggplot(aes(exclude)) +
    geom_histogram(stat='count') +
    coord_flip() +
    xlab("Excluded articles") +
    theme_bw() +
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()))

# Publication year
table(data$Pub_year)
summary(data %>% group_by(aid,Pub_year) %>% summarise())
minyr <- min(data$Pub_year)-1;maxyr <- max(data$Pub_year)+1
(pPubyr<- data %>% 
    group_by(aid,Pub_year) %>% 
    summarise() %>% 
    ggplot(aes(Pub_year))+
    geom_histogram(stat='count') +
    scale_x_continuous("Publication year", breaks=seq(minyr,maxyr,5)) +
    theme_bw() +
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()))

# Publication type
data %>% group_by(Pub_type) %>% summarise(num=n_distinct(aid), pct=num/75)
(pPubtype<-ste_gp(Pub_type) +
  xlab("Publication type"))

# Author affliation
data %>% group_by(auth_aff) %>% summarise(num=n_distinct(aid), pct=num/75) %>% arrange(desc(num))
(pAuth_aff<-ste_gp(auth_aff) +
  xlab("Author affliation"))
grep("Affil_type",names(data),value=T)
data %>% group_by(Affil_type.Academic) %>% summarise(num=n_distinct(aid), pct=num/75)
data %>% group_by(Affil_type.Research_Institute) %>% summarise(num=n_distinct(aid), pct=num/75)
data %>% group_by(Affil_type.Non_profit) %>% summarise(num=n_distinct(aid), pct=num/75)
data %>% group_by(Affil_type.Public_sector) %>% summarise(num=n_distinct(aid), pct=num/75)
data %>% group_by(Affil_type.International_Organization) %>% summarise(num=n_distinct(aid), pct=num/75)

#Author country
auth_ctry_sum <-data %>% 
  gather("X","Country", auth_ctry1:auth_ctry2) %>% 
  filter(!is.na(Country)) %>% 
  select(-X) %>% 
  group_by(Country) %>% 
  summarise(n=n_distinct(aid), pct=n/75) %>% 
  arrange(desc(pct))
auth_ctry_sum


# --------- Intervention general information
# Country/Region (values per study: i.e. x% of studies where in this region)
# FYI: Study_country=Int_location
ctry <- data %>% group_by(aid,Study_country) %>%  summarise() %>%
        left_join(country,by=c("Study_country"="Country")) %>% 
  # quick fix for NAs, multi-country studies
        mutate(Region=ifelse(aid==67396,"Latin America",Region),Subregion=ifelse(aid==67396,"Caribbean & Central America",Subregion),
               Region=ifelse(aid==67550,"Northern America",Region),Subregion=ifelse(aid==67550,"Northern & Central America",Subregion),
               Region=ifelse(aid==68668,"Asia",Region),Subregion=ifelse(aid==68668,"South-Eastern Asia",Subregion))

# number of sub-regions
ctry %>% group_by(Subregion) %>% summarise(num=n_distinct(aid), pct=num/75) %>% arrange(-pct)
ctry %>% group_by(Subregion) %>% summarise(num=n_distinct(aid), pct=num/75) %>% arrange(-pct) %>% filter(grepl("Central America",Subregion))

(pSubRegion<-  ctry %>%
    group_by(Subregion) %>% 
    summarise(num=n_distinct(aid)) %>% 
    mutate(x.labels=ordered(Subregion)) %>% 
    ggplot(aes(x=reorder(x.labels,num),y=num))+
    geom_bar(stat='identity', fill='blue', width = 1) +
    xlab("Sub-Region") +
    coord_flip())

# Num of countries
ctry <- data %>%
  mutate(Study_country=gsub(",",";",Study_country),
         Study_country=gsub("Tanzania; United Republic Of","Tanzania, United Republic Of",Study_country),
         Study_country=gsub("Taiwan; Province Of China","Taiwan, Province Of China",Study_country)) %>%
  group_by(aid,Study_country) %>%
  summarise()
ctry <-   as.data.frame(x=unlist(strsplit(as.character(ctry$Study_country),'; ',fixed=TRUE)))
 names(ctry) <- 'ctry'
ctry_sum <-ctry %>%
  mutate(ctry=as.character(ctry)) %>%
  group_by(ctry) %>%
  count() %>%
  left_join(country,by=c("ctry"="Country"))
nrow(ctry_sum) # number of unique countries
head(ctry_sum)

# Country (values by country: i.e. x% of countries assessed where in this region )
# ctry_sum %>% group_by(Subregion) %>% summarise(num=sum(n), pct=num/75)
# (pSubRegion<-  ctry_sum %>%
#     filter(!is.na(n)) %>% 
#     group_by(Subregion) %>% 
#     summarise(num=sum(n)) %>% 
#     arrange(-num) %>% 
#     mutate(x.labels=ordered(Subregion)) %>% 
#     ggplot(aes(x=reorder(x.labels,num),y=num))+
#     geom_bar(stat='identity', fill='blue', width = 1) +
#     xlab("Sub-Region") +
#     coord_flip())

# Biome
data %>% group_by(Biome.) %>% summarise(num=n_distinct(aid), pct=num/75) %>%  arrange(desc(num))
(pBiome<-ste_gp(Biome.) +
  xlab("Biome"))
Biome <- data %>% group_by(Biome.) %>% summarise(num=n_distinct(aid), pct=num/75) %>% 
  mutate (coral=ifelse(grepl("coral",Biome.),1,0)) 
sum(Biome$pct[Biome$coral==1])

# Intervention type
data %>% group_by(Int_type) %>% summarise(num=n_distinct(aid), pct=num/75)
data %>% mutate (Int_type=ifelse(grepl("MPA",Int_type),"MPA",Int_type)) %>% group_by(Int_type) %>% summarise(num=n_distinct(aid), pct=num/75) 
(pInt_typ<-ste_gp(Int_type) +
  xlab("Intervention type"))

  # waffle plot
int.type <- data %>% group_by(Int_type) %>% summarise(num=n_distinct(aid), pct=paste0("(",round((num/75)*100)," %)")) %>% 
              unite("Intervention",Int_type,pct, sep=" ") %>% arrange (-num)
(pInt_typ.waffle <- waffle(int.type, rows = 7, title="Intervention type", colors = rev(c("black","#6baed6","#084594","#c6dbef"))))

# Intervention scale
data %>% group_by(int_scale) %>% summarise(num=n_distinct(aid), pct=num/75)
(pInt_scale<-ste_gp(int_scale) +
  xlab("Intervention scale"))
# Study scale
data %>% group_by(stdy_scl) %>% summarise(num=n_distinct(aid), pct=num/75)
(pStdy_scl<-ste_gp(stdy_scl) +
  xlab("Study scale"))

# Age and size
unique(data$Int_dur)
int.area <- as.data.frame(unique(data$Int_area)) %>% 
  mutate(unit="unknown",
         unit= ifelse(grepl("ha",unique(data$Int_area)),"ha",unit),
         unit= ifelse(grepl("km",unique(data$Int_area)),"sqkm",unit),
         unit= ifelse(grepl("mi",unique(data$Int_area)),"sqmi",unit),
         unit= ifelse(grepl("nautical miles",unique(data$Int_area)),"sqnmi",unit))
# gsub("[^0-9]", "", unique(data$Int_area)) 

 #--- Study design
# Type of study
data %>% group_by(Study_type) %>% summarise(num=n_distinct(aid), pct=num/75)
(pStudy_typ<-ste_gp(Study_type) +
  xlab("Study type"))

# Study data source
data %>% group_by(Data_source) %>% summarise(num=n_distinct(aid), pct=num/75)
(pStdy_source<-ste_gp(Data_source) +
  xlab("Study data source"))
# Control group
data %>% group_by(Design.control_comp) %>% summarise(n_distinct(aid))
(pCtrl_gp<-ste_gp(Design.control_comp) +
  xlab("Control group"))

# Control group type
data %>% group_by(Comp_type) %>% summarise(num=n_distinct(aid), pct=num/75)
(pCtrl_typ<-ste_gp(Comp_type) +
  xlab("Control group type"))

## Grouped plots
# About study
plot_grid(pExclude,pPubyr,pPubtype,pAuth_aff,
          labels=letters[1:4], ncol = 2, nrow = 2, hjust=-1)

# About intervention
plot_grid(pInt_scale,pSubRegion
          ,labels=letters[1:4], ncol = 2, nrow = 1, hjust=-1)

# About study design
plot_grid(pStudy_typ,pStdy_source,pStdy_scl,pCtrl_gp,
          labels=letters[1:4], ncol = 2, nrow = 2, hjust=-1)
```

### Outcome-level plots
```{r eval=T}
# Outcome domain 
data %>% group_by(Out_type) %>% summarise(num=n_distinct(aid), pct=num/75) %>% arrange(desc(num))
(pOut_domain <- ste_gp_o('Out_type') %>% 
ggplot(aes(x=reorder(Out_type,num),y=num))+
  ste_hist() +
  xlab('Outcome domain'))

# Outcome sub-domains
 # find out the max # subtypes per row for separation
 max.subtypes <- paste0("o.sub",rep(1:max(str_count(data$Out_subtype, ",")+1)))
 outcomes2 <-data %>% 
   select(aid,oid,Out_type,Out_subtype) %>% 
   separate(Out_subtype,max.subtypes, sep=", ",fill="right") %>% # fill=right fills blanks with NAs
   gather("X","Out_subtype", max.subtypes) %>% 
   filter(!is.na(Out_subtype)) %>% 
   select(-X) %>% 
   group_by(Out_type,Out_subtype) %>% 
   count()
outcomes2 %>% group_by(Out_subtype) %>% summarise(num=sum(n), pct=num/75) %>% arrange(desc(num))

  # CPUE and food security
cpue.terms <-   c(grep("catch",data$Indicators,value=T), grep("PUE",data$Indicators,value=T,ignore.case = F),
                  grep("increased sizes of species",data$Indicators,value=T,ignore.case = F))
unique(data$Indicators[data$Indicators%in%cpue.terms & grepl("food security",data$Out_subtype)])
data$Indicators[!data$Indicators%in%cpue.terms & grepl("food security",data$Out_subtype)]
data <- data %>% 
   mutate(cpue =ifelse(Indicators%in%cpue.terms & grepl("food security",Out_subtype),1,0))
sum(data$cpue)
length(grep("food security",data$Out_subtype,value=T))
data %>% filter(grepl("food security",Out_subtype)) %>% group_by(cpue) %>% summarise(num=n_distinct(aid), pct=num/24) %>% arrange(desc(num))

# Data type
table(data$Outcome.data_type)/sum(!is.na(data$Outcome.data_type))
(pDatatype <-  ste_gp_o('Outcome.data_type') %>% 
  ggplot(aes(x=reorder(Outcome.data_type,num),y=num))+
  ste_hist() +
  xlab("Outcome data type") + ylab("# cases"))

# demographic groups
data %>% 
  mutate_at(vars(STE_econ:STE_social_org),funs(ifelse(is.na(.),0,1))) %>% 
  group_by(aid) %>% summarise_at(vars(STE_econ:STE_social_org), funs(max(.))) %>% 
  gather("STE","val", STE_econ:STE_social_org) %>% 
  group_by(STE) %>% 
  summarise(num=sum(val),pct=num/75)
  arrange(desc(num))
# scale
data %>% 
  mutate_at(vars(STE_spatial:STE_temporal_scale),funs(ifelse(is.na(.),0,1))) %>% 
  group_by(aid) %>% summarise_at(vars(STE_spatial:STE_temporal_scale), funs(max(.))) %>% 
  gather("STE","val", STE_spatial:STE_temporal_scale) %>% 
  group_by(STE) %>% 
  summarise(num=sum(val),pct=num/75)
  arrange(desc(num))


# Perceived vs observed
table(data$Out_definition)
data$outcome_obs1 <- ifelse(data$Out_definition%in%c('Researcher','Respondent'),
                                data$Out_definition,"Both")
table(data$outcome_obs1)/sum(!is.na(data$outcome_obs1))
(pDataobs <- ste_gp_o('outcome_obs1') %>% 
  ggplot(aes(x=reorder(outcome_obs1,num),y=num))+
  ste_hist() +
  xlab("Data 'observer'")+ ylab("# cases"))

# order.gp <- data %>% group_by(Out_type) %>% summarise(n=n_distinct(oid)) %>% arrange(desc(n)) %>% pull(Out_type)
## Perceptions and data type
(pDataobs.type <- data %>% 
          group_by(outcome_obs1,Outcome.data_type) %>% 
          summarise(n=n_distinct(oid)) %>% 
          ggplot(aes(x=Outcome.data_type,y=n)) +
          geom_bar(aes(fill = outcome_obs1),stat = 'identity') +
          scale_fill_manual(values = c("lightblue","blue", "darkblue")) +
          labs(x="Data type", y="# outcomes", fill="Data observer") +
          coord_flip() +
          theme_bw() +
          theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()))
(pDatatyp.stdytype <- data %>%
          group_by(Outcome.data_type,Study_type) %>%
          summarise(n=n_distinct(oid)) %>%
          ggplot(aes(x=Study_type,y=n)) +
          geom_bar(aes(fill = Outcome.data_type),stat = 'identity') +
          scale_fill_manual(values = c("skyblue1", "lightblue","blue", "darkblue")) +
          labs(x="Study type", y="# outcomes", fill="Outcome data type") +
          coord_flip() +
          theme_bw() +
          theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()))
(pDataobs.stdytype <- data %>% 
          group_by(outcome_obs1,Study_type) %>% 
          summarise(n=n_distinct(oid)) %>% 
          ggplot(aes(x=Study_type,y=n)) +
          geom_bar(aes(fill = outcome_obs1),stat = 'identity') +
          scale_fill_manual(values = c("lightblue","blue", "darkblue")) +
          labs(x="Study type", y="# outcomes", fill="Data observer") +
          coord_flip() +
          theme_bw() +
          theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()))
(pOut_type.stdytype <- data %>% 
          group_by(Out_type,Study_type) %>% 
          summarise(n=n_distinct(oid)) %>% 
          ggplot(aes(x=Out_type,y=n)) +
          geom_bar(aes(fill = Study_type),stat = 'identity') +
          scale_fill_manual(values = c("lightblue","blue", "darkblue")) +
          labs(x="Outcome type", y="# outcomes", fill="Study type") +
          coord_flip() +
          theme_bw() +
          theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()))
(pOut_type.dataobs <- data %>% 
          group_by(Out_type,outcome_obs1) %>% 
          summarise(n=n_distinct(oid)) %>% 
          ggplot(aes(x=Out_type,y=n)) +
          geom_bar(aes(fill = outcome_obs1),stat = 'identity') +
          scale_fill_manual(values = c("lightblue","blue", "darkblue")) +
          labs(x="Outcome type", y="# outcomes", fill="Data observer") +
          coord_flip() +
          theme_bw() +
          theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()))
(pOut_type.datatyp <- data %>% 
          group_by(Out_type,Outcome.data_type) %>% 
          summarise(n=n_distinct(oid)) %>% 
          ggplot(aes(x=Out_type,y=n)) +
          geom_bar(aes(fill = Outcome.data_type),stat = 'identity') +
          scale_fill_manual(values = c("skyblue1", "lightblue","blue", "darkblue")) +
          labs(x="Outcome type", y="# outcomes", fill="Data type") +
          coord_flip() +
          theme_bw() +
          theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()))


# Dimensions
ste.data <- data %>% 
  select(STE_domain:STE_temporal_scale)

ste.data1 <-as.data.frame(apply(ste.data, 2, function(x) sum(!is.na(x))))
names(ste.data1)[1] <- "total"
ste.data1$var <- gsub('STE_','',row.names(ste.data1))

(pSTE <- ggplot(ste.data1,aes(x=reorder(var,total),y=total)) +
    ste_hist() +
    xlab("STE dimension") )

plot_grid(pDatatype,pDataobs,pOut_domain, pSTE,labels=letters[1:4], 
          ncol = 2, nrow = 2, hjust=-1)
minyr <- min(data$Pub_year)-1;maxyr <- max(data$Pub_year)+1

         
# # Demographic groups
# (pSTE_demo_time <-  data %>%
#   select(aid,Pub_year,STE_econ:STE_occupation) %>% 
#   gather("STE_type","val",STE_econ:STE_occupation) %>% 
#   filter(!is.na(val)) %>% 
#   group_by(Pub_year,STE_type) %>% 
#   summarise(ste_per_yr= n_distinct(aid))  %>% 
#   mutate(STE_type=gsub("STE_","",STE_type)) %>% 
#   ggplot(aes(x=Pub_year,y=ste_per_yr)) +
#   geom_bar(aes(fill = STE_type),stat = 'identity') +
#   scale_x_continuous("Publication Year", breaks=seq(minyr,maxyr,5)) +
#   scale_y_continuous("Frequency", breaks=seq(0,10,2)) )
# 
# # Scale groups
# (pSTE_scale_time <-  data %>%
#   select(aid,Pub_year,STE_spatial:STE_temporal_scale) %>% -
#   gather("STE_type","val",STE_spatial:STE_temporal_scale) %>% 
#   filter(!is.na(val)) %>% 
#   group_by(Pub_year,STE_type) %>% 
#   summarise(ste_per_yr= n_distinct(aid))  %>% 
#   mutate(STE_type=gsub("STE_","",STE_type)) %>% 
#   ggplot(aes(x=Pub_year,y=ste_per_yr)) +
#   geom_bar(aes(fill = STE_type),stat = 'identity') +
#   scale_x_continuous("Publication Year", breaks=seq(minyr,maxyr,5)) +
#   scale_y_continuous("Frequency", breaks=seq(0,10,2)) )

```

### Heat maps
```{r eval=T}
# out_type <- c("Economic well-being","Health","Political empowerment","Social capital","Education","Culture")
# int_type <- c("MPA","PES","CBM","CBMPA","Certification")
# 
# io_counts = matrix(nrow=6, ncol=5)
# rownames(io_counts) <- out_type
# colnames(io_counts) <-int_type
# 
# for (i in int_type){
#   for (j in out_type){
#     subset <- filter(data, Out_type == j, Int_type == i)
#     io_counts[j,i] <- n_distinct(subset$aid)
#   }
# }
# 
# rownames(io_counts) <- out_type
# colnames(io_counts) <- int_type
# io_counts <- as.data.frame(io_counts)
# io_counts$Out_type <- rownames(io_counts)
# io_counts <- gather(io_counts,"Int_type","n",1:5)

#------ Domains
io_counts <- data %>% 
        group_by(Int_type,Out_type) %>% 
        count() %>% 
        spread(key=Int_type, value=n) %>% 
    #   mutate(PES=0) %>%
        gather("Int_type","n",CBM:MPA) %>% 
        mutate(n=ifelse(is.na(n),0,as.integer(n)))

(heat.map.domain <- ggplot(io_counts, aes(x=Out_type,y=Int_type,fill=n)) +
  geom_tile(color="gray90",size=0.1) +
  geom_text(aes(label=n),show.legend = F) +
  scale_fill_gradient(low="#f7fbff",high="#2171b5",name="# Cases",na.value="gray90") +
  coord_equal() +
# theme_tufte(base_family="Helvetica") +    # having issues with font, font colour in windows...
  theme(axis.ticks=element_line(size=0.4)) +
  theme(axis.text=element_text(size=12)) +
  theme(legend.title=element_text(size=10)) +
  theme(legend.text=element_text(size=10)) +
  theme(legend.title.align=1) +
  theme(legend.position="bottom") +
  theme(legend.key.size=unit(1, "cm")) +
  theme(legend.key.width=unit(1, "cm")) +
  xlab("Domain") +
  ylab("Intervention") +
  theme(axis.text.x = element_text(angle=45,hjust=1,size=12)))

#------ Demographic groups
head(id_counts)
id_counts <- data %>% 
  select(aid,Int_type,STE_econ:STE_occupation) %>%
  mutate_at(vars(STE_econ:STE_occupation),funs(ifelse(is.na(.),0,1))) %>%
  group_by(aid,Int_type) %>% 
  summarise_all(funs(max)) %>% 
  ungroup() %>% 
  select(-aid) %>% 
  group_by(Int_type) %>% 
  summarise_all(funs(sum)) %>% 
  gather("ste_type","n",STE_econ:STE_occupation) %>% 
  mutate(ste_type=gsub("STE_","",ste_type))

(heat.map.demog <- ggplot(id_counts, aes(x=ste_type,y=Int_type,fill=n)) +
  geom_tile(color="gray90",size=0.1) +
  geom_text(aes(label=n),show.legend = F) +
  scale_fill_gradient(low="#f7fbff",high="#2171b5",name="# Cases",na.value="gray90") +
  coord_equal() +
# theme_tufte(base_family="Helvetica") +    # having issues with font, font colour in windows...
  theme(axis.ticks=element_line(size=0.4)) +
  theme(axis.text=element_text(size=12)) +
  theme(legend.title=element_text(size=10)) +
  theme(legend.text=element_text(size=10)) +
  theme(legend.title.align=1) +
  theme(legend.position="bottom") +
  theme(legend.key.size=unit(1, "cm")) +
  theme(legend.key.width=unit(1, "cm")) +
  scale_x_discrete(name="Demographic group", labels=c("age","econ. gp","ethnicity","occupation","sex", "social gp")) +
  ylab("Intervention") +
  theme(axis.text.x = element_text(angle=45,hjust=1,size=12)))

#------ Scales
head(is_counts)
is_counts <- data %>% 
  select(aid,Int_type,STE_spatial:STE_temporal_scale) %>%
  mutate_at(vars(STE_spatial:STE_temporal_scale),funs(ifelse(is.na(.),0,1))) %>%
  group_by(aid,Int_type) %>% 
  summarise_all(funs(max)) %>% 
  ungroup() %>% 
  select(-aid) %>% 
  group_by(Int_type) %>% 
  summarise_all(funs(sum)) %>% 
  gather("ste_type","n",STE_spatial:STE_temporal_scale) %>% 
  mutate(ste_type=gsub("STE_","",ste_type))

(heat.map.scale <- ggplot(is_counts, aes(x=ste_type,y=Int_type,fill=n)) +
  geom_tile(color="gray90",size=0.1) +
  geom_text(aes(label=n),show.legend = F) +
  scale_fill_gradient(low="#f7fbff",high="#2171b5",name="# Cases",na.value="gray90") +
  coord_equal() +
# theme_tufte(base_family="Helvetica") +    # having issues with font, font colour in windows...
  theme(axis.ticks=element_line(size=0.4)) +
  theme(axis.text=element_text(size=12)) +
  theme(legend.title=element_text(size=10)) +
  theme(legend.text=element_text(size=10)) +
  theme(legend.title.align=1) +
  theme(legend.position="bottom") +
  theme(legend.key.size=unit(1, "cm")) +
  theme(legend.key.width=unit(1, "cm")) +
  scale_x_discrete(name="Scale", labels=c("spatial units","temporal scale","temporal units")) +
  ylab("Intervention") +
  theme(axis.text.x = element_text(angle=45,hjust=1,size=12)))


##BY STE TYPE AND OUTCOME DOMAIN - HEATMAP

# ste_outcomes <- select(data,aid,oid,Int_type,Out_type,STE_domain,STE_econ,STE_social,STE_sex,STE_ethnic,STE_age,STE_social_org,STE_social_org,STE_spatial,STE_temporal_unit,STE_temporal_scale) %>% distinct() 
# 
# ste_outcomes2 <- ste_outcomes %>% gather("ste_type","ste_interaction",5:15) %>% arrange(Int_type) %>% filter(ste_interaction != "NA") %>% distinct() %>% filter(!is.na(Out_type)) %>% filter(!is.na(Int_type))
# 
# n_distinct(ste_outcomes2$aid)
# n_distinct(ste_outcomes2$oid)
# 
# ste_outcomes3 <- ste_outcomes2 %>% select(-aid)

# ste_types <- c("STE_domain","STE_econ","STE_social","STE_sex","STE_ethnic","STE_age","STE_social_org","STE_social_org","STE_spatial","STE_temporal_unit","STE_temporal_scale")
# 
# # matrix <- count(ste_outcomes3,Out_type,Int_type,ste_type)
# # matrix2 <- matrix %>% ungroup() %>% mutate(Int_type=factor(Int_type, levels=c("MPA","CBM","CBMPA","Certification")))
# # matrix2$n <- as.numeric(matrix2$n)
# 
# ste_outcomes <- data %>% 
#   select(aid,oid,Int_type,Out_type,STE_domain:STE_temporal_scale) %>% 
#   distinct() %>% 
#   gather("ste_type","ste_interaction",STE_domain:STE_temporal_scale) %>% 
#   arrange(Int_type) %>% 
#   filter(ste_interaction != "NA") %>% 
#   distinct() %>% 
#   filter(!is.na(Out_type)) %>% 
#   filter(!is.na(Int_type))
# 
# n_distinct(ste_outcomes$aid)
# n_distinct(ste_outcomes$oid)
# 
# matrix2 <- ste_outcomes %>% 
#   select(-aid) %>% 
#   count(Out_type,Int_type,ste_type) %>% 
#   ungroup() %>% 
#   mutate(Int_type=factor(Int_type, levels=c("MPA","CBM","CBMPA","Certification")),
#          n=as.numeric(n)) 
# 
# all_poss <- expand.grid(Out_type=unique(matrix2$Out_type),ste_type=unique(matrix2$ste_type),Int_type=unique(matrix2$Int_type))
# all_merge <- merge(matrix2,all_poss,by=c("Out_type","ste_type","Int_type"),all=TRUE) %>% arrange(Int_type)

# heat.map.int <- ggplot(all_merge, aes(x=ste_type,y=Out_type,fill=n)) + 
#   geom_tile(color="gray90",size=0.1) +
#   geom_text(aes(label=n, color="white")) +
#   scale_fill_gradient(low="#f7fbff",high="#084594",name="# Cases",na.value="gray90") +
#   coord_equal() +
#   facet_wrap(~Int_type, ncol=3) +
#   labs(x="STE Type",y=NULL,
#        title=paste0("STEs observed in domains of human well-being amongst marine conservation interventions (",
#                     n_distinct(ste_outcomes$oid), " cases in ",n_distinct(ste_outcomes$aid)," articles)")) +
#   theme_tufte(base_family="Helvetica") +
#   theme(plot.title=element_text(hjust=0)) +
#   theme(axis.ticks=element_line(size=0.4)) +
#   theme(axis.text=element_text(size=7)) +
#   theme(panel.border=element_rect(fill=NA,size=0.1)) +
#   theme(strip.text=element_text(hjust=0)) +
#   theme(panel.spacing.x=unit(0.5, "cm")) +
#   theme(panel.spacing.y=unit(0.5, "cm")) +
#   theme(legend.title=element_text(size=6)) +
#   theme(legend.text=element_text(size=6)) +
#   theme(legend.title.align=1) +
#   theme(legend.position="bottom") +
#   theme(legend.key.size=unit(0.2, "cm")) +
#   theme(legend.key.width=unit(1, "cm")) +
#   theme(axis.text.x = element_text(angle=45,hjust=1,size=7))
# 
# heat.map.int
```
### Plot world map
I can't seem to get the fortify function to work on my system with Sam's map so using broom::tidy.Need to verify
```{r eval=T}
# Summarise data by country 

# fix data in country column
ctry <- data %>%
  mutate(Study_country=gsub(",",";",Study_country),
         Study_country=gsub("Tanzania; United Republic Of","Tanzania, United Republic Of",Study_country),
         Study_country=gsub("Taiwan; Province Of China","Taiwan, Province Of China",Study_country)) %>%
  group_by(aid,Study_country) %>%
  summarise()

# no. articles per country
max.ctry <- paste0("ctry",rep(1:max(str_count(ctry$Study_country, ";")+1))) # create vector of column names for each country
ctry_sum <-ctry %>% 
  separate(Study_country,max.ctry, sep="; ",fill="right") %>% # fill=right fills blanks with NAs
  gather("X","Country", max.ctry) %>% 
  filter(!is.na(Country)) %>% 
  select(-X) %>% 
  group_by(Country) %>% 
  count() 
arrange(ctry_sum,desc(n))

#arrange(ctry_sum,desc(n))
#ctry <-   as.data.frame(x=unlist(strsplit(as.character(ctry$Study_country),'; ',fixed=TRUE)))
#names(ctry) <- 'ctry'
# ctry_sum <-ctry %>% 
#   mutate(ctry=as.character(ctry)) %>% 
#   group_by(ctry) %>% 
#   add_count()  
# head(ctry_sum1)

# join to full country list
ctry_sum1 <- country %>% 
  left_join(ctry_sum,by="Country") %>%
  mutate(n=replace(n, is.na(n), 0)) 

ctry_sum$Country[!ctry_sum$Country%in%ctry_sum1$Country] # any missing?

# read in map
map <- rgdal::readOGR(paste0(datadir,"TM_WORLD_BORDERS-0.3/TM_WORLD_BORDERS-0.3.shp"))
map <-broom::tidy(map,region="ISO3")
#map@data[map@data$NAME=="Turks and Caicos Islands",]
#plot
(study_ctry_map <- ggplot() +
  geom_map(data=ctry_sum1, aes(map_id=code, fill=n),map=map) +
  expand_limits(x=map$long,y=map$lat) +
  theme(panel.background = element_rect(fill = "#525252", colour = "#525252"), panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  scale_fill_gradient2(low="white",mid="#2171b5",high="#08519c",
                       midpoint=(max(ctry_sum1$n)/2),limits=c(0,max(ctry_sum1$n))))


#--------------------- Author institution location (country)
auth_ctry_sum <-data %>% 
  gather("X","Country", auth_ctry1:auth_ctry2) %>% 
  filter(!is.na(Country)) %>% 
  select(-X) %>% 
  group_by(Country) %>% 
  summarise(n=n_distinct(aid), pct=n/75) %>% 
  arrange(desc(pct))
auth_ctry_sum

#load in full country list
auth_ctry_sum1 <- country %>% 
  left_join(auth_ctry_sum,by="Country") %>%
  mutate(n=replace(n, is.na(n), 0)) 

auth_ctry_sum$Country[!auth_ctry_sum$Country%in%auth_ctry_sum1$Country] # any missing?

# read in map
map <- rgdal::readOGR(paste0(datadir,"TM_WORLD_BORDERS-0.3/TM_WORLD_BORDERS-0.3.shp"))
map <-broom::tidy(map,region="ISO3")
#map@data[map@data$NAME=="Turks and Caicos Islands",]
#plot
(auth_ctry_map <- ggplot() +
  geom_map(data=auth_ctry_sum1, aes(map_id=code, fill=n),map=map) +
  expand_limits(x=map$long,y=map$lat) +
  theme(panel.background = element_rect(fill = "#525252", colour = "#525252"), panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  scale_fill_gradient2(low="white",mid="#2171b5",high="#08519c",
                       midpoint=(max(auth_ctry_sum1$n)/2),limits=c(0,max(auth_ctry_sum1$n))))


#--------------- Connections (https://www.gis-blog.com/flight-connection-map-with-r/)
#fix data in country column
connect <- data %>%
  mutate(Study_country=gsub(",",";",Study_country),
         Study_country=gsub("Tanzania; United Republic Of","Tanzania, United Republic Of",Study_country),
         Study_country=gsub("Taiwan; Province Of China","Taiwan, Province Of China",Study_country)) %>%
  group_by(aid,auth_ctry1,Study_country) %>%
  summarise()
head(connect)

max.ctry <- paste0("ctry",rep(1:max(str_count(connect$Study_country, ";")+1))) # create vector of column names for each country
connect1 <-connect %>%
  separate(Study_country,max.ctry, sep="; ",fill="right") %>% # fill=right fills blanks with NAs
  gather("X","Country", max.ctry) %>%
  filter(!is.na(Country)) %>%
  select(-X) %>%
  group_by(auth_ctry1,Country) %>%
  count() %>%
  rename(stdy_ctry="Country")
head(connect1)

# get lat lon for country centroids
map <- st_read(paste0(datadir,"TM_WORLD_BORDERS-0.3/TM_WORLD_BORDERS-0.3.shp")) %>% 
        left_join(ctry_sum1,by= c("ISO3"="code")) %>% 
        mutate(n=replace(n, is.na(n), 0))
map.pts <- st_centroid(map) %>%
  st_set_geometry(NULL) %>% 
  select(ISO3,LON,LAT)
head(map.pts)

connect2 <- connect1 %>% 
  left_join(select(country,Country,code),by=c("stdy_ctry"="Country")) %>% 
  rename(stdy_code=code) %>% 
  mutate(stdy_code=ifelse(stdy_ctry=="Bahamas","BHS",stdy_code)) %>% 
  left_join(select(country,Country,code),by=c("auth_ctry1"="Country")) %>% 
  rename(auth_code=code) %>% 
  left_join(map.pts,by=c("stdy_code"="ISO3")) %>% 
  rename(stdy_lat=LAT,stdy_lon=LON) %>% 
  left_join(map.pts,by=c("auth_code"="ISO3")) %>% 
  rename(auth_lat=LAT,auth_lon=LON) %>% 
  mutate(stdy_lon=ifelse(stdy_code==auth_code,stdy_lon-1,stdy_lon),
         stdy_lat=ifelse(stdy_code==auth_code,stdy_lat-1,stdy_lat),
         auth_lon=ifelse(stdy_code==auth_code,auth_lon+1,auth_lon),
         auth_lat=ifelse(stdy_code==auth_code,auth_lat+1,auth_lat))

auth.pts <- st_as_sf(connect2,coords = c("auth_lon","auth_lat")) %>% st_set_crs(st_crs(map))
stdy.pts <- st_as_sf(connect2,coords = c("stdy_lon","stdy_lat")) %>% st_set_crs(st_crs(map))

inter <- geosphere::gcIntermediate(connect2[,c("auth_lon","auth_lat")], connect2[,c("stdy_lon","stdy_lat")], n=200,
                                   breakAtDateLine=T,sp=T)
inter.sf <- st_as_sf(inter) %>% 
          bind_cols(connect2) 
#inter.sf[grepl("Eygpt",inter.sf$stdy_ctry),]
(auth_stdy_connect <- ggplot() +
    geom_sf(data =map, aes(fill = n)) +
      theme(panel.background = element_rect(fill = "#525252", colour = "#525252"),panel.grid = element_blank()) +
  geom_sf(data =auth.pts, aes(col = "chocolate1"),size=0.5,show.legend=F) +
  geom_sf(data =stdy.pts, aes(col = "chocolate1"),size=0.5,show.legend=F) +
  geom_sf(data =inter.sf, aes(col = "turquoise2"),show.legend=F))
 # expand_limits(x=map.connect$long,y=map.connect$lat) +
  # scale_fill_gradient2(low="black",mid="#2171b5",high="#08519c",
  #                      midpoint=(max(connect2$n)/2),limits=c(0,max(connect2$n))))


#--------------- Repeat authors
# get unique author list
auth_list <- data %>% 
  group_by(aid) %>% 
  summarise(Authors=first(Authors))
auth_words <- paste(auth_list$Authors, collapse = " ")

stop_words <- c("and") # words to exclude

auth_rpt <-data_frame(text = auth_words) %>% 
  mutate(text=gsub(" *\\b[[:alpha:]]{1,2}\\b *", " ", text),
         text = gsub('[[:punct:] ]+',' ',text),
         text = tolower(text), 
         tokens = str_split(text, "\\s+")) %>%
  unnest() %>% 
  count(tokens) %>% 
  filter(!tokens %in% stop_words) %>% 
  mutate(freq = n / sum(n)) %>% 
  arrange(desc(n))

auth_rpt # Christie and Pollnac the most repeated authors, but only 3 times




#----------------------
# #create basemap
# maps::map("world", fill=T, col="grey8", bg="grey15")
# #overlay source country
# points(test2[,c("auth_lon","auth_lat")], pch=3, cex=0.1, col="chocolate1")

#load in full country list
# country <- read.csv(paste0(datadir,"allcountries.csv"), head=TRUE, sep=",")
# names(country) <- c("Study_country", "Region", "Code", "Subregion")
# regions <- country
# regions <- arrange(regions,Region)
# 
# #Fix aids with multiple countries
# ctry <- data %>% 
#   group_by(aid,Study_country) %>% 
#   summarise() %>% 
#   separate(Study_country,c('ctry1','ctry2'),sep=",",remove = F) %>%
#   filter(ctry2 != " United Republic Of") %>%
#   filter(ctry2 != " Province Of China") %>%
#   gather(key=ctry.col,value=ctry,ctry1:ctry2) %>%
#   select(aid,ctry)
# 
# colnames(ctry) <- c("aid","Study_country")
# 
# for_plotting <- select(data,aid,Study_country)
# ctry <- bind_rows(ctry,for_plotting)
# 
# ##Count number of studies for all countries and arrange by region
# country_count <- matrix(nrow=nrow(regions), ncol=2)
# rownames(country_count) <- regions$Study_country
# colnames(country_count) <- c("Study_country", "counts")
# #Calculate in for loop and write to blank matrix
# for (c in regions$Study_country){
#   subset <- filter(ctry, Study_country == c)
#   country_count[c,1] <- c
#   country_count[c,2] <- as.numeric(n_distinct(subset$aid))
# }
# #Remove rownames and reformat data types
# rownames(country_count) = NULL
# country_count <- as.data.frame(country_count, stringsAsFactors=FALSE)
# countries_only <- inner_join(country_count,regions,by="Study_country")
# countries_only <- filter(countries_only, Code != "")
# 
# countries_only$counts <- as.numeric(countries_only$counts)
# countries_only <- as.data.frame(countries_only)
# countries_zero <- filter(countries_only, counts == 0)
# 
# map <- readShapeSpatial(paste0(datadir,"TM_WORLD_BORDERS-0.3/TM_WORLD_BORDERS-0.3.shp"))
# plot(map)
# map <-broom::tidy(map,region="ISO3")
# 
# map <- fortify(map, region="ISO3")
# 
# pdf(file=paste0(datadir,"STE_Country_Map_dark_5_11.pdf"), width=16, height=8.5)
# ggplot() +
#   geom_map(data=countries_only, aes(map_id=Code, fill=counts),map=map) +
#   geom_map(data=countries_zero, aes(map_id=Code),fill="#f0f0f0",map=map) +
#   expand_limits(x=map$long,y=map$lat) +
#   theme(panel.background = element_rect(fill = "darkgray", colour = "darkgray"), panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
#   scale_fill_gradient2(low="#f7fbff",mid="#6baed6",high="#08306b",midpoint=(max(countries_only$counts)/2),limits=c(0,max(countries_only$counts)))
# dev.off()
# # map <- st_read(paste0(datadir,"TM_WORLD_BORDERS-0.3/TM_WORLD_BORDERS-0.3.shp")) 
# # plot(map)
# # head(map)
# # map <- fortify(map, region="ISO3")
# # 
```
### Chord diagram
No tradeoffs for CBM
Minor error where some combinations are separated as 2 different chords (e.g.CBM-both: Social and Political:1, Political and Social: 2) 
```{r eval=T}
###########################
##FOR MPAS
###########################
mpa_outcomes <- filter(data,Int_type == "MPA") %>% distinct()
mpa.syn <- filter(mpa_outcomes,STE_domain == "Synergy") %>% arrange(Out_type,aid)
mpa.tradeoff <- filter(mpa_outcomes,STE_domain == "Tradeoff") %>% arrange(Out_type,aid)
mpa.both <- filter(mpa_outcomes,STE_domain == "Both Syn/Trd") %>% arrange(Out_type,aid)

#Create input for tradeoffs
aid <- as.list(unique(mpa.tradeoff$aid))
# links <- matrix(nrow=1,ncol=3)
# colnames(links) <- c("source","target","aid")
# links <- as.data.frame(links)
links <- data.frame(source=NA,target=NA,aid=NA)

for(i in aid){
  sub <- filter(mpa.tradeoff, aid == i)
  if(nrow(sub) > 1){
    sub2 <- as.data.frame(t(combn(sub$Out_type, 2)))
    colnames(sub2) <- c("source","target")
    sub2$aid <- c(i)
    links <- bind_rows(links,sub2)
  } else 
    links
}

links <- slice(links,-1)

##Count links 
mpa.counts.trdoff <- count(links,source,target)
colnames(mpa.counts.trdoff) <- c("source","target","value") 
mpa.counts.trdoff <- as.data.frame(mpa.counts.trdoff)

##For synergies
aid2 <- as.list(unique(mpa.syn$aid))
links2 <- data.frame(source=NA,target=NA,aid=NA)

for(i in aid2){
  sub <- filter(mpa.syn, aid == i)
  if(nrow(sub) > 1){
    sub2 <- as.data.frame(t(combn(sub$Out_type, 2)))
    colnames(sub2) <- c("source","target")
    sub2$aid <- c(i)
    links2 <- bind_rows(links2,sub2)
  } else 
    links2
}

links2 <- slice(links2,-1)

##Count links 
mpa.counts.syn <- count(links2,source,target)
colnames(mpa.counts.syn) <- c("source","target","value") 
mpa.counts.syn <- as.data.frame(mpa.counts.syn)

#Create input for both
aid3 <- as.list(unique(mpa.both$aid))
links3 <- data.frame(source=NA,target=NA,aid=NA)

for(i in aid3){
  sub <- filter(mpa.both, aid == i)
  if(nrow(sub) > 1){
    sub2 <- as.data.frame(t(combn(sub$Out_type, 2)))
    colnames(sub2) <- c("source","target")
    sub2$aid <- c(i)
    links3 <- bind_rows(links3,sub2)
  } else 
    links3
}

links3 <- slice(links3,-1)

##Count links 
mpa.counts.both <- count(links3,source,target)
colnames(mpa.counts.both) <- c("source","target","value") 
mpa.counts.both <- as.data.frame(mpa.counts.both)

grid.col <- c("Economic well-being"="#66c2a5","Social capital"="#fc8d62", "Culture"="#8da0cb", "Political empowerment"="#e78ac3","Education"="#a6d854","Health"="#ffd92f")
#pdf(file=paste0(datadir,"STE by Domain - MPA_4_24.pdf"),width=11,height=8.5)
par(mfrow=c(1,2),oma=c(0,0,2,0))
chordDiagram(as.data.frame(mpa.counts.trdoff), transparency = 0.3, grid.col=grid.col) 
title(paste0("Tradeoffs (n=",length(unique(mpa.tradeoff$aid))," articles, x=",nrow(mpa.tradeoff)," cases)"),line=-3.5)
chordDiagram(as.data.frame(mpa.counts.both), transparency = 0.3, grid.col=grid.col)
title(paste0("Both (n=",length(unique(mpa.both$aid))," articles, x=",nrow(mpa.both)," cases)"),line=-3.5)
chordDiagram(as.data.frame(mpa.counts.syn), transparency = 0.3, grid.col=grid.col)
title(paste0("Synergies (n=",length(unique(mpa.syn$aid))," articles, x=",nrow(mpa.syn)," cases)"),line=-3.5)
mtext("STE by outcome domain type in MPAs",outer=TRUE,cex=1.5)
#dev.off()

###########################
## for CBM
###########################
cbnrm_outcomes <- filter(data,Int_type %in% c("CBRNM_MPA","CBM")) %>% distinct()
cbnrm.syn <- filter(cbnrm_outcomes,STE_domain == "Synergy") %>% arrange(Out_type,aid)
cbnrm.tradeoff <- filter(cbnrm_outcomes,STE_domain == "Tradeoff") %>% arrange(Out_type,aid)
cbnrm.both <- filter(cbnrm_outcomes,STE_domain == "Both Syn/Trd")

#Create input for tradeoffs
aid <- as.list(unique(cbnrm.tradeoff$aid))
links <- data.frame(source=NA,target=NA,aid=NA)

for(i in aid){
  sub <- filter(cbnrm.tradeoff, aid == i)
  if(nrow(sub) > 1){
    sub2 <- as.data.frame(t(combn(sub$Out_type, 2)))
    colnames(sub2) <- c("source","target")
    sub2$aid <- c(i)
    links <- bind_rows(links,sub2)
  } else 
    links
}

links <- slice(links,-1)

##Count links 
counts <- count(links,source,target)
colnames(counts) <- c("source","target","value") 
counts <- as.data.frame(counts)

##For synergies

aid2 <- as.list(unique(cbnrm.syn$aid))
links2 <- data.frame(source=NA,target=NA,aid=NA)

for(i in aid2){
  sub <- filter(cbnrm.syn, aid == i)
  if(nrow(sub) > 1){
    sub2 <- as.data.frame(t(combn(sub$Out_type, 2)))
    colnames(sub2) <- c("source","target")
    sub2$aid <- c(i)
    links2 <- bind_rows(links2,sub2)
  } else 
    links2
}

links2 <- slice(links2,-1)

##Count links 
cbnrm.counts.syn <- count(links2,source,target)
colnames(cbnrm.counts.syn) <- c("source","target","value") 
cbnrm.counts.syn <- as.data.frame(cbnrm.counts.syn)

##For both

aid3 <- as.list(unique(cbnrm.both$aid))
links3 <- data.frame(source=NA,target=NA,aid=NA)

for(i in aid3){
  sub <- filter(cbnrm.both, aid == i)
  if(nrow(sub) > 1){
    sub3 <- as.data.frame(t(combn(sub$Out_type, 2)))
    colnames(sub3) <- c("source","target")
    sub3$aid <- c(i)
    links3 <- bind_rows(links3,sub3)
  } else 
    links3
}

links3 <- slice(links3,-1)

##Count links 
cbnrm.counts.both <- count(links3,source,target)
colnames(cbnrm.counts.both) <- c("source","target","value") 
cbnrm.counts.both <- as.data.frame(cbnrm.counts.both)

grid.col <- c("Economic well-being"="#66c2a5","Social capital"="#fc8d62", "Culture"="#8da0cb", "Political empowerment"="#e78ac3","Education"="#a6d854","Health"="#ffd92f")
#pdf(file=paste0(datadir,"STE by Domain - CBNRM_4_24.pdf"),width=11,height=8.5)
par(mfrow=c(1,2),oma=c(0,0,2,0))
# chordDiagram(as.data.frame(counts), transparency = 0.3, grid.col=grid.col) # no tradeoff data?
# title(paste0("Tradeoffs (n=",length(aid)," articles, x=",nrow()," cases)"),line=-3.5)
chordDiagram(as.data.frame(cbnrm.counts.syn), transparency = 0.3, grid.col=grid.col)
title("Synergies (n=8 articles, x=21 cases)",line=-3.5)
chordDiagram(as.data.frame(cbnrm.counts.both), transparency = 0.3, grid.col=grid.col)
title("Both (n=8 articles, x=21 cases)",line=-3.5)
mtext("STE by outcome domain type in CBM",outer=TRUE,cex=1.5)
#dev.off()
```
### Treemapping
```{r eval=T}
#Treemapping to look at outcome subtypes within outcome domains

# find out the max # subtypes per row for separation
max.subtypes <- paste0("o.sub",rep(1:max(str_count(data$Out_subtype, ",")+1))) 
outcomes2 <-data %>% 
  select(aid,oid,Int_type,Out_type,Out_subtype) %>% 
  separate(Out_subtype,max.subtypes, sep=", ",fill="right") %>% # fill=right fills blanks with NAs
  gather("X","Out_subtype", max.subtypes) %>% 
  filter(!is.na(Out_subtype)) %>% 
  select(-X) %>% 
  group_by(Int_type,Out_type,Out_subtype) %>% 
  count(aid)
outcomes2 %>% group_by(Out_subtype) %>% summarise(num=sum(n), pct=num/75) %>% arrange(desc(num))
sum(outcomes2$n)
head(outcomes2)

export(outcomes2 %>% spread(Int_type,n),
       paste0(outputdir,"outcome subtypes by intervention.csv"))

# get n for each high level group
outcomes3 <-outcomes2 %>% 
  left_join(outcomes2 %>% 
    group_by(Int_type,Out_type) %>% 
    summarise(int_sum=sum(n))) %>% 
  left_join(outcomes2 %>% 
    group_by(Out_type) %>% 
    summarise(all_sum=sum(n))) %>% 
    mutate(Out_type_all=paste0(Out_type,"\n (",all_sum,(")")),
           Out_type_int=paste0(Out_type,"\n (",int_sum,(")"))) 
mpa_tree_count <- filter(outcomes3,Int_type == "MPA") 
cbnrm_tree_count <- filter(outcomes3,Int_type == "CBM") 
cbnrm_mpa_tree_count <- filter(outcomes3,Int_type == "CBMPA") 

#pdf(file=paste0(datadir,"Outcome_attr_by_domain_MPA.pdf"))
treemap(outcomes3,index=c("Out_type_all","Out_subtype"),
        vSize="n",
        type="index",
        fontsize.labels = c(15,10),
        fontcolor.labels=c("white","black"),
        fontface.labels=c(2,1),
        bg.labels=c("transparent"),
        align.labels=list(
          c("center","top"),
          c("left","bottom")
        ),
        overlap.labels=0.5,
        inflate.labels=F,
        title="All interventions")

#pdf(file=paste0(datadir,"Outcome_attr_by_domain_MPA.pdf"))
treemap(mpa_tree_count,index=c("Out_type_int","Out_subtype"),
        vSize="n",
        type="index",
        fontsize.labels = c(15,10),
        fontcolor.labels=c("white","black"),
        fontface.labels=c(2,1),
        bg.labels=c("transparent"),
        align.labels=list(
          c("center","top"),
          c("left","bottom")
        ),
        overlap.labels=0.5,
        inflate.labels=F,
        title="MPAs")
# dev.off()
# pdf(file=paste0(datadir,"Outcome_attr_by_domain_CBNRM.pdf"))
treemap(cbnrm_tree_count,index=c("Out_type_int","Out_subtype"),
        vSize="n",
        type="index",
        fontsize.labels = c(15,10),
        fontcolor.labels=c("white","black"),
        fontface.labels=c(2,1),
        bg.labels=c("transparent"),
        align.labels=list(
          c("center","top"),
          c("left","bottom")
        ),
        overlap.labels=0.5,
        inflate.labels=F,
        title="CBM")
# dev.off()

# pdf(file=paste0(datadir,"Outcome_attr_by_domain_CBNRM_MPA.pdf"))
treemap(cbnrm_mpa_tree_count,index=c("Out_type_int","Out_subtype"),
        vSize="n",
        type="index",
        fontsize.labels = c(15,10),
        fontcolor.labels=c("white","black"),
        fontface.labels=c(2,1),
        bg.labels=c("transparent"),
        align.labels=list(
          c("center","top"),
          c("left","bottom")
        ),
        overlap.labels=0.5,
        inflate.labels=F,
        title="CBMPA")
#dev.off()
```

### Values over time
Still need to figure out other graphs over time:

* rate of change?
* make prettier 
```{r eval=T}
# demographic_ste <- c("STE_age", "STE_econ","STE_ethnic","STE_occupation","STE_sex","STE_social")
# spat_temp_ste <- c("STE_spatial","STE_temporal_unit","STE_temporal_scale")
# pub_per_yr <-data %>%
#   select(aid,Pub_year) %>% 
#   group_by(Pub_year) %>% 
#   summarise(pub_per_yr= n_distinct(aid))
# STE_time <-  data %>%
#   select(aid,Pub_year,STE_domain:STE_temporal_scale) %>% 
#   mutate(STE_demogr = ifelse(rowSums(!is.na(.[demographic_ste]))>0,"1",NA),
#          STE_spatial_temp= ifelse(rowSums(!is.na(.[spat_temp_ste]))>0,"1",NA)) %>% 
#   gather("STE_type","val",STE_domain:STE_spatial_temp) %>% 
#   filter(!is.na(val)) %>% 
#   group_by(Pub_year,STE_type) %>% 
#   summarise(ste_per_yr= n_distinct(aid)) %>% 
#   left_join(pub_per_yr,by="Pub_year")  %>% 
#   spread(STE_type,value = ste_per_yr) %>% 
#   mutate_at(vars(pub_per_yr:STE_temporal_unit),funs(replace(., is.na(.), 0))) %>% 
#   ungroup() %>% 
#   arrange(Pub_year) %>% 
#   mutate_at(vars(pub_per_yr:STE_temporal_unit),funs(cumsum(.))) 
# tail(STE_time)
# 
# pSTE_domain <- ggplot(STE_time,aes(x = Pub_year, y=STE_domain)) +
#     ylab("Frequency") + scale_x_continuous(name="Year", breaks=seq(1985,2020,5)) +
#     ggtitle('Domain')+ylim(c(0,60))+geom_line(aes(y = STE_domain))
# pSTE_econ <- ggplot(STE_time,aes(x = Pub_year, y=STE_econ)) +
#     ylab("Frequency") + scale_x_continuous(name="Year", breaks=seq(1985,2020,5)) +
#     ggtitle('Econ gp')+ylim(c(0,40))+geom_line(aes(y = STE_econ))
# pSTE_social <- ggplot(STE_time,aes(x = Pub_year, y=STE_social)) +
#     ylab("Frequency") + scale_x_continuous(name="Year", breaks=seq(1985,2020,5)) +
#     ggtitle('socialgp')+ylim(c(0,40))+geom_line(aes(y = STE_social))
# pSTE_sex <- ggplot(STE_time,aes(x = Pub_year, y=STE_sex)) +
#     ylab("Frequency") + scale_x_continuous(name="Year", breaks=seq(1985,2020,5)) +
#     ggtitle('sex')+ylim(c(0,40))+geom_line(aes(y = STE_sex))
# pSTE_ethnic <- ggplot(STE_time,aes(x = Pub_year, y=STE_ethnic)) +
#     ylab("Frequency") + scale_x_continuous(name="Year", breaks=seq(1985,2020,5)) +
#     ggtitle('ethnicgp')+ylim(c(0,40))+geom_line(aes(y = STE_ethnic))
# pSTE_age <- ggplot(STE_time,aes(x = Pub_year, y=STE_age)) +
#     ylab("Frequency") + scale_x_continuous(name="Year", breaks=seq(1985,2020,5)) +
#     ggtitle('age')+ylim(c(0,40))+geom_line(aes(y = STE_age))
# pSTE_occupation <- ggplot(STE_time,aes(x = Pub_year, y=STE_occupation)) +
#     ylab("Frequency") + scale_x_continuous(name="Year", breaks=seq(1985,2020,5)) +
#     ggtitle('occupation')+ylim(c(0,40))+geom_line(aes(y = STE_occupation))
# pSTE_social_org <- ggplot(STE_time,aes(x = Pub_year, y=STE_social_org)) +
#     ylab("Frequency") + scale_x_continuous(name="Year", breaks=seq(1985,2020,5)) +
#     ggtitle('organization')+ylim(c(0,40))+geom_line(aes(y = STE_social_org))
# pSTE_spatial <- ggplot(STE_time,aes(x = Pub_year, y=STE_spatial)) +
#     ylab("Frequency") + scale_x_continuous(name="Year", breaks=seq(1985,2020,5)) +
#     ggtitle('spatial_units')+ylim(c(0,40))+geom_line(aes(y = STE_spatial))
# pSTE_temporal_unit <- ggplot(STE_time,aes(x = Pub_year, y=STE_temporal_unit)) +
#     ylab("Frequency") + scale_x_continuous(name="Year", breaks=seq(1985,2020,5)) +
#     ggtitle('temporal_units')+ylim(c(0,40))+geom_line(aes(y = STE_temporal_unit))
# pSTE_temporal_scale <- ggplot(STE_time,aes(x = Pub_year, y=STE_temporal_scale)) +
#     ylab("Frequency") + scale_x_continuous(name="Year", breaks=seq(1985,2020,5)) +
#     ggtitle('temporal_scale')+ylim(c(0,40))+geom_line(aes(y = STE_temporal_scale))
# pSTE_demo <- ggplot(STE_time,aes(x = Pub_year, y=STE_demo)) +
#     ylab("Frequency") + scale_x_continuous(name="Year", breaks=seq(1985,2020,5)) +
#     ggtitle('Demographic')+ylim(c(0,100))+geom_line(aes(y = STE_demogr))
# pSTE_spatial_temp <- ggplot(STE_time,aes(x = Pub_year, y=STE_spatial_temp)) +
#     ylab("Frequency") + scale_x_continuous(name="Year", breaks=seq(1985,2020,5)) +
#     ggtitle('Spatio-temporal')+ylim(c(0,60))+geom_line(aes(y = STE_spatial_temp))
# 
# plot_grid(pSTE_domain, pSTE_econ,pSTE_social,pSTE_sex,
#           pSTE_ethnic,pSTE_age,pSTE_occupation,
#           pSTE_spatial,pSTE_temporal_unit,pSTE_temporal_scale,
#           labels=letters[1:12], ncol = 4, nrow = 3, hjust=-1)

# STE_time_gps <- STE_time %>%
#   select(Pub_year,pub_per_yr,STE_domain,STE_demogr,STE_spatial_temp) %>%
#   gather("STE_gp","val",pub_per_yr:STE_spatial_temp) %>% 
#   mutate(STE_gp=gsub("STE_","",STE_gp),
#         STE_gp=gsub("demogr","demographic_group",STE_gp) )
# (pSTE_time_gps <- ggplot(STE_time_gps)  + 
#   geom_line(aes(x = Pub_year, y = val, group = STE_gp, colour = STE_gp))  +
#   ylab("Frequency") + scale_x_continuous(name="Year", breaks=seq(1985,2020,5)) +
#   ggtitle('Groups')+ylim(c(0,80)) )
#  # direct.label(pSTE_time_gps,list(cex=1.5, "last.qp"))
 
#- Growth by intervention
All_time_gps <- data %>%
  group_by(Pub_year) %>% 
  summarise(pub.per.yr= n_distinct(aid)) %>% 
  ungroup() %>% 
  arrange(Pub_year) %>% 
  mutate(val=cumsum(pub.per.yr),
         gp="All") %>% 
    select(Pub_year,gp,val)
tail(All_time_gps)
# growth by decade
#overall
(max(All_time_gps$val)-min(All_time_gps$val))/(max(All_time_gps$Pub_year)-min(All_time_gps$Pub_year))
#1990s
(max(All_time_gps$val[All_time_gps$Pub_year<2000])-max(All_time_gps$val[All_time_gps$Pub_year<1990]))/10
#2000s
(max(All_time_gps$val[All_time_gps$Pub_year<2010])-max(All_time_gps$val[All_time_gps$Pub_year<2000]))/10
#2000-latest date
(max(All_time_gps$val)-max(All_time_gps$val[All_time_gps$Pub_year<2010]))/(max(All_time_gps$Pub_year)-2009)

Int_time_gps <-  data %>%
  group_by(Pub_year,Int_type) %>% 
  summarise(int_per_yr= n_distinct(aid)) %>% 
  spread(Int_type,value = int_per_yr) %>% 
  mutate_at(vars(CBM:MPA),funs(replace(., is.na(.), 0))) %>% 
  ungroup() %>% 
  arrange(Pub_year) %>% 
  mutate_at(vars(CBM:MPA),funs(cumsum(.))) %>% 
  gather("int_typ","val",CBM:MPA) %>% 
  bind_rows(All_time_gps %>% rename(int_typ=gp))
tail(Int_time_gps)
# non-elegant way to convert units to factor in order to reorder plot legends
order.gp <- Int_time_gps %>% group_by(int_typ) %>% summarise(order_typ=max(val)) %>% arrange(desc(order_typ)) %>% pull(int_typ)
Int_time_gps <- Int_time_gps %>%  
  mutate(int_typ = factor(int_typ, levels = order.gp)) %>% 
  rename(Intervention=int_typ)

int.cols <- c("black","blue","orangered1","yellow4","tan1")
names(int.cols) <- order.gp

(pInt_time_gps <- ggplot(Int_time_gps)  + 
  geom_line(aes(x = Pub_year, y = val, group = Intervention, colour = Intervention), size = 1.3)  +
  ylab("Frequency") + scale_x_continuous(name="Year", breaks=seq(1985,2025,5)) +
  scale_colour_manual(values=int.cols) +
  ggtitle('Intervention type')+
  scale_y_continuous(limits=c(0,80), breaks=seq(0,80,10), labels=c("0","","20","","40","","60","","80")))

#--- Growth by domain
STE_time_dom <-  data %>%
  group_by(Pub_year,Out_type) %>% 
  summarise(dom_per_yr= n_distinct(aid))   %>%
  spread(Out_type,value = dom_per_yr) %>% 
  mutate_at(vars(Culture:`Social capital`),funs(replace(., is.na(.), 0))) %>%
  ungroup() %>% 
  arrange(Pub_year) %>% 
  mutate_at(vars(Culture:`Social capital`),funs(cumsum(.))) %>% 
  gather("out_typ","val",Culture:`Social capital`) %>% 
  bind_rows(All_time_gps %>% rename(out_typ=gp))
tail(STE_time_dom)

# non-elegant way to convert units to factor in order to reorder plot legends
order.gp <- STE_time_dom %>% group_by(out_typ) %>% summarise(order_typ=max(val)) %>% arrange(desc(order_typ)) %>% pull(out_typ)
STE_time_dom <- STE_time_dom %>%
  mutate(out_typ = factor(out_typ, levels = order.gp)) %>%
  rename(Outcome_type=out_typ)

dom.cols <- c("black","blue","orangered1","yellow4","tan1","violet","palegreen3")
names(dom.cols) <- order.gp

(pSTE_time_dom <- ggplot(STE_time_dom)  + 
  geom_line(aes(x = Pub_year, y = val, group = Outcome_type, colour = Outcome_type),size=1.3)  +
  ylab("Frequency") + scale_x_continuous(name="Year", breaks=seq(1985,2025,5)) +
  scale_colour_manual(values=dom.cols) +
  ggtitle('Domain') +
  scale_y_continuous(limits=c(0,80), breaks=seq(0,80,10), labels=c("0","","20","","40","","60","","80")))

#--- Growth by STE (demographic group)
STE_time <-  data %>%
  select(aid,Pub_year,STE_domain:STE_temporal_scale) %>%
  gather("STE_type","val",STE_domain:STE_temporal_scale) %>%
  filter(!is.na(val)) %>%
  group_by(Pub_year,STE_type) %>%
  summarise(ste_per_yr= n_distinct(aid)) %>%
  spread(STE_type,value = ste_per_yr) %>%
  mutate_at(vars(STE_age:STE_temporal_unit),funs(replace(., is.na(.), 0))) %>%
  ungroup() %>%
  arrange(Pub_year) %>%
  mutate_at(vars(STE_age:STE_temporal_unit),funs(cumsum(.)))

STE_time_demog <- STE_time %>%
  select(Pub_year,STE_age,STE_econ,STE_ethnic,STE_occupation,STE_sex,STE_social) %>%
  gather("STE_gp","val",STE_age:STE_social) %>% 
  mutate(STE_gp=gsub("STE_","",STE_gp)) %>% 
  bind_rows(All_time_gps %>% rename(STE_gp=gp))
  # non-elegant way to convert units to factor in order to reorder plot legends
order.gp <- STE_time_demog %>% group_by(STE_gp) %>% summarise(order_typ=max(val)) %>% arrange(desc(order_typ)) %>% pull(STE_gp)
STE_time_demog <- STE_time_demog %>%  
  mutate(STE_gp = factor(STE_gp, levels = order.gp)) %>% 
  rename(Group=STE_gp)

ste.cols <- c("black","blue","orangered1","yellow4","tan1","violet","palegreen3")
names(ste.cols) <- order.gp

(pSTE_time_demog <-  ggplot(STE_time_demog)  + 
  geom_line(aes(x = Pub_year, y = val, group = Group, colour = Group),size=1.3)  +
  ylab("Frequency") + scale_x_continuous(name="Year", breaks=seq(1985,2025,5)) +
  scale_colour_manual(values=ste.cols) +
  ggtitle('Demographic groups') +
  scale_y_continuous(limits=c(0,80), breaks=seq(0,80,10), labels=c("0","","20","","40","","60","","80")))

#--- Growth by scale
STE_scale_gps <- STE_time %>%
  select(Pub_year,STE_spatial,STE_temporal_scale,STE_temporal_unit) %>%
  gather("STE_gp","val",STE_spatial:STE_temporal_unit) %>% 
  mutate(STE_gp=gsub("STE_","",STE_gp),
         STE_gp=gsub("spatial","spatial_unit",STE_gp)) %>% 
  bind_rows(All_time_gps %>% rename(STE_gp=gp))

# non-elegant way to convert units to factor in order to reorder plot legends
order.gp <- STE_scale_gps %>% group_by(STE_gp) %>% summarise(order_typ=max(val)) %>% arrange(desc(order_typ)) %>% pull(STE_gp)
STE_scale_gps <- STE_scale_gps %>%
  mutate(STE_gp = factor(STE_gp, levels = order.gp))%>%
  rename(Scale=STE_gp)

ste.cols <- c("black","blue","orangered1","yellow4")
names(ste.cols) <- order.gp

(pSTE_scale_gps <- ggplot(STE_scale_gps)  + 
  geom_line(aes(x = Pub_year, y = val, group = Scale, colour = Scale),size=1.3)  +
  ylab("Frequency") + scale_x_continuous(name="Year", breaks=seq(1985,2025,5)) +
  scale_colour_manual(values=ste.cols) +
  ggtitle('Scale') +
  scale_y_continuous(limits=c(0,80), breaks=seq(0,80,10), labels=c("0","","20","","40","","60","","80")))

plot_grid(pInt_time_gps, pSTE_time_dom,pSTE_time_demog,pSTE_scale_gps,
          labels=letters[1:4], ncol = 2, nrow = 2, hjust=-1)

#--- Study type over time

minyr <- min(data$Pub_year)-1
maxyr <- max(data$Pub_year)+1

Study_type.lbl <- data %>% 
  group_by(Study_type) %>% 
  summarise(num=n_distinct(aid)) %>% 
  mutate(x.label=paste0(Study_type," (",num,")"))

group.colors <-matrix( c("#02818a","#67a9cf","#084594"),nrow=1)
names(group.colors) <- Study_type.lbl$x.label
  
(pStudy_typ_time <- data %>% 
  group_by(Pub_year,Study_type) %>% 
  summarise(num=n_distinct(aid)) %>%
  arrange(Pub_year) %>% 
  ungroup() %>% 
  left_join(select(Study_type.lbl,Study_type,x.label),by="Study_type") %>% 
  ggplot(aes(x=Pub_year,y=num)) +
  geom_bar(aes(fill = x.label),stat = 'identity') +
  scale_x_continuous("Publication year", breaks=seq(minyr,maxyr,5)) +
  scale_y_continuous("Frequency", breaks=seq(0,10,2)) +
  scale_fill_manual(values=group.colors)) +
  guides(fill=guide_legend(title=NULL))

```

### Export plots
Fix case numbers in chord diagrams
```{r, EVAL =F}
#-- Intervention & study plots
## about study
plot_grid(pPubyr,pPubtype,pAuth_aff,
          labels=letters[1:3], ncol = 2, nrow = 2, hjust=-1)
ggsave(paste0(outputdir,'STE pub info.jpg'),width = 10.5,height = 6)
## about intervention
plot_grid(pInt_typ,pInt_scale,pSubRegion
          ,labels=letters[1:4], ncol = 2, nrow = 2, hjust=-1)
ggsave(paste0(outputdir,'STE intervention info.jpg'),width = 14,height = 9)
pInt_typ.waffle 
ggsave(paste0(outputdir,'STE intervention waffle.jpg'),width = 8,height = 4)

## about study
plot_grid(pStdy_scl,pStdy_source,pStudy_typ,pCtrl_gp,
          labels=letters[1:4], ncol = 2, nrow = 2, hjust=-1)
ggsave(paste0(outputdir,'STE study info.jpg'),width = 10.5,height = 6)
## outcomes
plot_grid(pDatatype,pDataobs,pOut_domain, pSTE,labels=letters[1:4], 
          ncol = 2, nrow = 2, hjust=-1)
ggsave(paste0(outputdir,'STE outcome summaries.jpg'),width = 10.5,height = 6)
## outcomes (stacked)
plot_grid(pDataobs.type,pDatatyp.stdytype,pDataobs.stdytype,
          pOut_type.stdytype,pOut_type.datatyp,pOut_type.dataobs,  
          labels=letters[1:6], 
          ncol = 3, nrow = 2, hjust=-1)
ggsave(paste0(outputdir,'STE outcome summaries-stacked.jpg'),width = 14,height = 6)
# Study design
plot_grid(pDatatype,pDataobs,pStudy_typ, pCtrl_gp,labels=letters[1:4], 
          ncol = 2, nrow = 2, hjust=-1)
ggsave(paste0(outputdir,'study design.jpg'),width = 7,height = 5)
# plot_grid(pDatatype,pDataobs,ncol = 1, nrow = 2, hjust=-1) +
#   theme(axis.text=element_text(size=14),axis.title=element_text(size=14,face="bold"))
# ggsave(paste0(outputdir,'study design1.jpg'),width = 4,height = 4)
# plot_grid(pStudy_typ, pCtrl_gp,ncol = 1, nrow = 2, hjust=-1)+
#   theme(axis.text=element_text(size=14),axis.title=element_text(size=14,face="bold"))
# ggsave(paste0(outputdir,'study design2.jpg'),width = 4,height = 4)

#-- World maps
png(file=paste0(outputdir,"STE_Country_Map_dark.png"), width=13.5, height=8, res=600, units = "in")
#pdf(file=paste0(outputdir,"STE_Country_Map_dark_5_11.pdf"), width=16, height=8.5)
study_ctry_map
dev.off()

png(file=paste0(outputdir,"Auth_Country_Map_dark.png"), width=13.5, height=8, res=600, units = "in")
#pdf(file=paste0(outputdir,"Auth_Country_Map_dark_5_11.pdf"), width=16, height=8.5)
auth_ctry_map
dev.off()

png(file=paste0(outputdir,"Auth_Study_Country_Map_dark.png"), width=13.5, height=16, res=600, units = "in")
#pdf(file=paste0(outputdir,"Auth_Country_Map_dark_5_11.pdf"), width=16, height=8.5)
plot_grid(auth_ctry_map + labs(title="Author insitutions"),
          study_ctry_map + labs(title="Study locations"),labels=letters[1:2], ncol = 1, nrow = 2, hjust=-1)
dev.off()

auth_stdy_connect + labs(title="Author insitution:study Site distance")
ggsave(paste0(outputdir,'auth_stdy_connect.jpg'),width = 10.5,height = 6)

#-- Heat maps
## heat maps
png(file=paste0(outputdir,"Heatmap_articles.png"), width=13.5, height=5, res=600, units = "in")
plot_grid(heat.map.domain,heat.map.demog, heat.map.scale,labels=letters[1:3], ncol = 3, nrow = 1, hjust=-1)
dev.off()

## individual maps

png(file=paste0(outputdir,"Int_domain_Heatmap_articles.png"), width=7, height=5, res=600, units = "in")
# pdf(file=paste0(outputdir,"STE_Int_Outcome_Heatmap_articles_test.pdf"), width=11, height=8.5)
heat.map.domain
dev.off()
png(file=paste0(outputdir,"Int_demographic_Heatmap_articles.png"), width=6, height=4, res=600, units = "in")
# pdf(file=paste0(outputdir,"STE_Int_Outcome_Heatmap_articles_test.pdf"), width=11, height=8.5)
heat.map.demog
dev.off()
png(file=paste0(outputdir,"Int_scale_Heatmap_articles.png"), width=5, height=4, res=600, units = "in")
# pdf(file=paste0(outputdir,"STE_Int_Outcome_Heatmap_articles_test.pdf"), width=11, height=8.5)
heat.map.scale
dev.off()
## all outcomes by intervention
#pdf(file=paste0(outputdir,"STE_type_Int_Outcome_Heatmap_5_11.pdf"), width=11, height=8.5)
png(file=paste0(outputdir,"Int_Outcome_STE_Heatmap_articles.png"), width=8, height=6, res=600, units = "in")
heat.map.int
dev.off()

#-- Chord diagrams # MPA pdf(file=paste0(outputdir,"STE by Domain -
#MPA_4_24.pdf"),width=11,height=8.5) par(mfrow=c(1,2),oma=c(0,0,2,0))
par(oma=c(0,0,2,0), cex=1.5,mfrow=c(1,1))
png(file=paste0(outputdir,"STE by Domain-MPA-tradeoffs.png"), width=6, height=4, res=600, units = "in")
chordDiagram(as.data.frame(mpa.counts.trdoff), transparency = 0.3, grid.col=grid.col)
title(paste0("Tradeoffs (n=",length(unique(mpa.tradeoff$aid))," articles, x=",nrow(mpa.tradeoff)," cases)"))
dev.off()
png(file=paste0(outputdir,"STE by Domain-MPA-synergies.png"), width=6, height=4, res=600, units = "in")
chordDiagram(as.data.frame(mpa.counts.syn), transparency = 0.3, grid.col=grid.col)
title(paste0("Synergies (n=",length(unique(mpa.syn$aid))," articles, x=",nrow(mpa.syn)," cases)"))
dev.off()
png(file=paste0(outputdir,"STE by Domain-MPA-both.png"), width=8, height=6, res=600, units = "in")
chordDiagram(as.data.frame(mpa.counts.both), transparency = 0.3, grid.col=grid.col)
title(paste0("Both (n=",length(unique(mpa.both$aid))," articles, x=",nrow(mpa.both)," cases)"))
dev.off()

#mtext("STE by outcome domain type in MPAs",outer=TRUE,cex=1.5)

## CBRNRM
# pdf(file=paste0(outputdir,"STE by Domain - CBNRM_4_24.pdf"),width=11,height=8.5)
# par(mfrow=c(1,2),oma=c(0,0,2,0))
# chordDiagram(as.data.frame(counts), transparency = 0.3, grid.col=grid.col) # no tradeoff data?
# title(paste0("Tradeoffs (n=",length(aid)," articles, x=",nrow()," cases)"),line=-3.5)
png(file=paste0(outputdir,"STE by Domain-CBM-syn.png"), width=8, height=6, res=600, units = "in")
chordDiagram(as.data.frame(cbnrm.counts.syn), transparency = 0.3, grid.col=grid.col)
title(paste0("Synergies (n=",length(unique(cbnrm.syn$aid))," articles, x=",nrow(cbnrm.syn)," cases)"))
dev.off()
png(file=paste0(outputdir,"STE by Domain-CBM-both.png"), width=8, height=6, res=600, units = "in")
chordDiagram(as.data.frame(cbnrm.counts.both), transparency = 0.3, grid.col=grid.col)
title(paste0("Both (n=",length(unique(cbnrm.both$aid))," articles, x=",nrow(cbnrm.both)," cases)"))
mtext("STE by outcome domain type in CBM",outer=TRUE,cex=1.5)
dev.off()

#-- Tree maps
# All interventions
png(file=paste0(outputdir,"Outcome_attr_by_domain_all.png"), width=9, height=8, res=600, units = "in")
treemap(outcomes3,index=c("Out_type_all","Out_subtype"),
        vSize="n",
        type="index",
        fontsize.labels = c(15,10),
        fontcolor.labels=c("white","black"),
        fontface.labels=c(2,1),
        bg.labels=c("transparent"),
        align.labels=list(
          c("center","top"),
          c("left","bottom")
        ),
        overlap.labels=0.5,
        inflate.labels=F,
        title="All interventions")
dev.off()
## MPA
png(file=paste0(outputdir,"Outcome_attr_by_domain_MPA.png"), width=9, height=9, res=600, units = "in")
#pdf(file=paste0(outputdir,"Outcome_attr_by_domain_MPA.pdf"))
treemap(mpa_tree_count,index=c("Out_type_int","Out_subtype"),
        vSize="n",
        type="index",
        fontsize.labels = c(12,11),
        fontcolor.labels=c("white","black"),
        fontface.labels=c(2,1),
        bg.labels=c("transparent"),
        align.labels=list(
          c("center","top"),
          c("left","bottom")
        ),
        overlap.labels=0.5,
        inflate.labels=F,
        title="MPAs")
dev.off()

## CBM
#pdf(file=paste0(outputdir,"Outcome_attr_by_domain_CBNRM.pdf"))
treemap(cbnrm_tree_count,index=c("Out_type_int","Out_subtype"),
        vSize="n",
        type="index",
        fontsize.labels = c(15,10),
        fontcolor.labels=c("white","black"),
        fontface.labels=c(2,1),
        bg.labels=c("transparent"),
        align.labels=list(
          c("center","top"),
          c("left","bottom")
        ),
        overlap.labels=0.5,
        inflate.labels=F,
        title="CBM")
dev.off()
## CBMPA
pdf(file=paste0(outputdir,"Outcome_attr_by_domain_CBNRM_MPA.pdf"))
treemap(cbnrm_mpa_tree_count,index=c("Out_type_int","Out_subtype"),
        vSize="n",
        type="index",
        fontsize.labels = c(15,10),
        fontcolor.labels=c("white","black"),
        fontface.labels=c(2,1),
        bg.labels=c("transparent"),
        align.labels=list(
          c("center","top"),
          c("left","bottom")
        ),
        overlap.labels=0.5,
        inflate.labels=F,
        title="CBMPA")
dev.off()

# # STE over time
# plot_grid(pSTE_domain, pSTE_econ,pSTE_social,pSTE_sex,
#           pSTE_ethnic,pSTE_age,pSTE_occupation,
#           pSTE_spatial,pSTE_temporal_unit,pSTE_temporal_scale,
#           labels=letters[1:12], ncol = 4, nrow = 3, hjust=-1)
# ggsave(paste0(outputdir,'STE_over_time.jpg'),width = 13,height = 7)

# study growth over time
plot_grid(pInt_time_gps, pSTE_time_dom,pSTE_time_demog,pSTE_scale_gps,
          labels=letters[1:4], ncol = 2, nrow = 2, hjust=-1)
ggsave(paste0(outputdir,'study_gps_over_time.jpg'),width = 15,height = 11)

# study type over time
pStudy_typ_time
ggsave(paste0(outputdir,'study_type_over_time.jpg'),width = 8,height = 4)

#  demographic over time
pSTE_demo_time
ggsave(paste0(outputdir,'demographic_over_time.jpg'),width = 11,height = 5)

#  scale over time
pSTE_scale_time 
ggsave(paste0(outputdir,'scale_over_time.jpg'),width = 11,height = 5)

```